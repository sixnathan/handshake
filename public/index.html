<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Handshake</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: "SF Mono", "Fira Code", "Cascadia Code", monospace;
  background: #0a0a0a;
  color: #e0e0e0;
  height: 100vh;
  overflow: hidden;
}

/* Setup screen */
#setup {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  padding: 24px;
  position: relative;
}
#setup h1 { color: #2d9c3c; margin-bottom: 4px; font-size: 32px; }
#setup .tagline { color: #666; font-size: 13px; margin-bottom: 28px; }
#setup form {
  display: flex; flex-direction: column; gap: 10px;
  width: 100%; max-width: 340px;
}
#setup input {
  background: #1a1a1a; border: 1px solid #333; color: #e0e0e0;
  padding: 12px 14px; font-size: 15px; font-family: inherit; border-radius: 6px;
}
#setup input:focus { border-color: #2d9c3c; outline: none; }
.room-row { display: flex; gap: 8px; }
.room-row input { flex: 1; }
#copyRoomBtn {
  background: #1a1a1a; border: 1px solid #333; color: #888;
  width: 42px; border-radius: 6px; cursor: pointer; font-size: 16px;
  display: flex; align-items: center; justify-content: center;
  transition: color 0.2s;
}
#copyRoomBtn:hover { color: #e0e0e0; border-color: #555; }
#setup button[type="submit"] {
  background: #2d9c3c; color: white; border: none; padding: 14px;
  font-size: 16px; font-family: inherit; border-radius: 6px; cursor: pointer; margin-top: 4px;
}
#setup button[type="submit"]:hover { background: #238b31; }
#setupStatus { color: #e74c3c; font-size: 14px; margin-top: 8px; }
#gearBtn {
  position: absolute; top: 20px; right: 20px;
  background: none; border: 1px solid #333; color: #888;
  width: 38px; height: 38px; border-radius: 6px; cursor: pointer;
  font-size: 18px; display: flex; align-items: center; justify-content: center;
  transition: color 0.2s, border-color 0.2s;
}
#gearBtn:hover { color: #e0e0e0; border-color: #555; }

/* Settings drawer */
#drawerOverlay {
  display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.5); z-index: 200;
}
#drawerOverlay.open { display: block; }
#settingsDrawer {
  position: fixed; top: 0; right: 0; bottom: 0;
  width: 380px; max-width: 90vw; z-index: 201;
  background: #111; border-left: 1px solid #222;
  transform: translateX(100%); transition: transform 0.3s ease;
  display: flex; flex-direction: column;
}
#settingsDrawer.open { transform: translateX(0); }
.drawer-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 16px 20px; border-bottom: 1px solid #222;
}
.drawer-header h2 { font-size: 16px; color: #e0e0e0; }
#closeDrawerBtn {
  background: none; border: none; color: #888; font-size: 22px; cursor: pointer;
  padding: 0 4px; line-height: 1;
}
#closeDrawerBtn:hover { color: #e0e0e0; }
.drawer-body {
  flex: 1; overflow-y: auto; padding: 16px 20px;
  display: flex; flex-direction: column; gap: 6px;
}
.drawer-body h3 {
  color: #888; font-size: 12px; text-transform: uppercase;
  letter-spacing: 1px; margin: 12px 0 4px; padding-top: 8px; border-top: 1px solid #1a1a1a;
}
.drawer-body h3:first-child { margin-top: 0; border-top: none; padding-top: 0; }
.drawer-body input, .drawer-body select, .drawer-body textarea {
  background: #1a1a1a; border: 1px solid #333; color: #e0e0e0;
  padding: 10px 12px; font-size: 14px; font-family: inherit; border-radius: 6px;
  width: 100%;
}
.drawer-body input:focus, .drawer-body select:focus, .drawer-body textarea:focus {
  border-color: #2d9c3c; outline: none;
}
.drawer-body textarea { min-height: 60px; resize: vertical; }
.drawer-body label {
  display: flex; align-items: center; gap: 8px; font-size: 13px; color: #aaa;
}
.drawer-body label input, .drawer-body label select { flex: 1; }
.currency-prefix {
  display: flex; align-items: center; gap: 0; font-size: 13px; color: #aaa;
}
.currency-prefix span {
  background: #1a1a1a; border: 1px solid #333; border-right: none;
  padding: 10px 8px 10px 12px; border-radius: 6px 0 0 6px; color: #888;
  font-size: 14px; min-width: 24px; text-align: center;
}
.currency-prefix input {
  border-radius: 0 6px 6px 0 !important; flex: 1;
}

/* Session screen */
#session { display: none; height: 100vh; flex-direction: column; }

/* ── Top Bar ────────────────────────────────── */
.top-bar {
  display: flex;
  align-items: center;
  padding: 12px 20px;
  background: #111;
  border-bottom: 1px solid #222;
  z-index: 10;
}
.top-bar-left {
  display: flex;
  align-items: center;
  gap: 10px;
  flex: 1;
}
.status-dot {
  width: 10px; height: 10px; border-radius: 50%; background: #f5a623;
  flex-shrink: 0;
}
.status-dot.connected { background: #2d9c3c; }
.status-dot.error { background: #e74c3c; }
@keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
.status-dot.waiting { animation: pulse-dot 1.5s infinite; }
#peerName {
  font-size: 16px;
  font-weight: bold;
  color: #e0e0e0;
}
.top-bar-center {
  flex: 1;
  text-align: center;
}
#callTimer {
  font-size: 20px;
  font-variant-numeric: tabular-nums;
  color: #888;
  letter-spacing: 1px;
}
.top-bar-right {
  flex: 1;
  display: flex;
  justify-content: flex-end;
}
#expandBtn {
  background: #1a1a1a;
  border: 1px solid #333;
  color: #aaa;
  padding: 6px 14px;
  font-size: 13px;
  font-family: inherit;
  border-radius: 4px;
  cursor: pointer;
  transition: background 0.15s, color 0.15s;
}
#expandBtn:hover { background: #222; color: #e0e0e0; }
#audioToggleBtn {
  background: #1a1a1a;
  border: 1px solid #333;
  color: #888;
  width: 36px; height: 36px;
  font-size: 18px;
  border-radius: 4px;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  margin-right: 8px;
  transition: color 0.15s, border-color 0.15s;
  position: relative;
}
#audioToggleBtn:hover { color: #e0e0e0; border-color: #555; }
#audioToggleBtn.unmuted { color: #2d9c3c; border-color: #2d9c3c; }

/* ── Call Center (default view) ──────────────── */
.call-center {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 16px;
  padding-bottom: 100px;
}
.pulse-ring {
  width: 160px;
  height: 160px;
  border-radius: 50%;
  border: 2px solid #2d9c3c;
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
}
.pulse-ring::before,
.pulse-ring::after {
  content: "";
  position: absolute;
  width: 100%;
  height: 100%;
  border-radius: 50%;
  border: 1px solid #2d9c3c;
  animation: pulse-ring-anim 2.5s ease-out infinite;
}
.pulse-ring::after {
  animation-delay: 1.25s;
}
@keyframes pulse-ring-anim {
  0% { transform: scale(1); opacity: 0.6; }
  100% { transform: scale(2.0); opacity: 0; }
}
.pulse-ring-inner {
  width: 16px;
  height: 16px;
  border-radius: 50%;
  background: #2d9c3c;
}
#callPeerName {
  font-size: 22px;
  font-weight: 600;
  color: #e0e0e0;
  margin-top: 8px;
}
#callPeerRole {
  font-size: 13px;
  color: #666;
  margin-top: -8px;
}
#callStatusText {
  font-size: 15px;
  color: #555;
  letter-spacing: 1px;
}

/* ── Call Action Bar ───────────────────────────── */
.call-action-bar {
  position: fixed;
  bottom: 0; left: 0; right: 0;
  display: flex;
  justify-content: center;
  gap: 20px;
  padding: 20px;
  background: linear-gradient(transparent, #0a0a0a 40%);
  z-index: 15;
}
.call-action-btn {
  width: 56px; height: 56px;
  border-radius: 50%;
  border: none;
  font-size: 22px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: transform 0.15s, background 0.15s;
  background: #222;
  color: #ccc;
}
.call-action-btn:hover { transform: scale(1.08); }
.call-action-btn.active { background: #2d9c3c; color: white; }
.call-action-btn.muted { background: #e74c3c; color: white; }
.call-action-btn.end { background: #e74c3c; color: white; }
.call-action-btn.end:hover { background: #c0392b; }

/* ── Negotiation Summary Card ──────────────── */
.neg-summary-card {
  display: none;
  background: #161616;
  border: 1px solid #2d9c3c33;
  border-radius: 12px;
  padding: 16px 20px;
  margin: 0 20px;
  width: 100%;
  max-width: 360px;
  text-align: left;
}
.neg-summary-card.visible { display: block; }
.neg-summary-title {
  font-size: 13px;
  color: #2d9c3c;
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 8px;
}
.neg-summary-amount {
  font-size: 28px;
  font-weight: 700;
  color: #e0e0e0;
  margin-bottom: 4px;
}
.neg-summary-detail {
  font-size: 12px;
  color: #666;
  line-height: 1.5;
}

/* ── Payment Receipt Card ──────────────────── */
.receipt-card {
  display: none;
  background: #161616;
  border: 1px solid #333;
  border-radius: 12px;
  padding: 16px 20px;
  margin: 0 20px;
  width: 100%;
  max-width: 360px;
  text-align: left;
}
.receipt-card.visible { display: block; }
.receipt-header {
  font-size: 11px;
  color: #888;
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 10px;
}
.receipt-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 0;
  border-bottom: 1px solid #1a1a1a;
}
.receipt-item:last-child { border-bottom: none; }
.receipt-dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}
.receipt-dot.processing { background: #f5a623; animation: pulse-dot 1s infinite; }
.receipt-dot.succeeded { background: #2d9c3c; }
.receipt-dot.failed { background: #e74c3c; }
.receipt-desc { flex: 1; font-size: 13px; color: #ccc; }
.receipt-amount { font-size: 13px; color: #e0e0e0; font-weight: 600; }
.receipt-check { color: #2d9c3c; font-size: 16px; }

/* ── Expanded View ──────────────────────────── */
.expanded-view {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: #0a0a0a;
  z-index: 50;
  flex-direction: column;
}
.expanded-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 20px;
  background: #111;
  border-bottom: 1px solid #222;
}
.expanded-header h2 {
  font-size: 16px;
  color: #e0e0e0;
  font-weight: 600;
}
#collapseBtn {
  background: none;
  border: none;
  color: #888;
  font-size: 22px;
  cursor: pointer;
  padding: 4px 8px;
  line-height: 1;
}
#collapseBtn:hover { color: #e0e0e0; }
.expanded-body {
  flex: 1;
  display: flex;
  overflow: hidden;
}

/* ── Dual-Column Transcript ─────────────────── */
.transcript-dual {
  flex: 1;
  display: flex;
  border-right: 1px solid #222;
  overflow: hidden;
}
.transcript-col {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}
.transcript-col-header {
  padding: 8px 12px;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: #555;
  background: #111;
  border-bottom: 1px solid #222;
  flex-shrink: 0;
}
.transcript-col-content {
  flex: 1;
  overflow-y: auto;
  padding: 8px 12px;
}
.transcript-divider {
  width: 1px;
  background: #222;
  flex-shrink: 0;
}

/* Transcript bubbles */
.t-bubble {
  margin-bottom: 8px;
  padding: 8px 10px;
  border-radius: 6px;
  background: #141414;
  border-left: 3px solid #2d9c3c;
  font-size: 13px;
  line-height: 1.5;
}
.t-bubble-peer {
  border-left-color: #3498db;
}
.t-bubble-partial {
  color: #555;
  font-style: italic;
  border-left-color: #333;
  background: #0f0f0f;
}
.t-bubble-time {
  display: block;
  font-size: 10px;
  color: #444;
  margin-top: 4px;
  font-variant-numeric: tabular-nums;
}

/* ── Workflow Timeline ──────────────────────── */
.workflow-timeline {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}
.workflow-timeline-header {
  padding: 8px 12px;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: #555;
  background: #111;
  border-bottom: 1px solid #222;
  flex-shrink: 0;
}
#timelineContent {
  flex: 1;
  overflow-y: auto;
  padding: 16px 16px 16px 32px;
  position: relative;
}
#timelineContent::before {
  content: "";
  position: absolute;
  left: 22px;
  top: 0;
  bottom: 0;
  width: 2px;
  background: #222;
}

/* Timeline nodes */
.tl-node {
  position: relative;
  padding: 0 0 16px 20px;
}
.tl-dot {
  position: absolute;
  left: -16px;
  top: 3px;
  width: 12px;
  height: 12px;
  border-radius: 50%;
  border: 2px solid #444;
  background: #0a0a0a;
}
.tl-text {
  font-size: 13px;
  color: #ccc;
  line-height: 1.4;
}
.tl-time {
  font-size: 10px;
  color: #444;
  margin-top: 2px;
  font-variant-numeric: tabular-nums;
}

/* Timeline node type colors */
.tl-detect .tl-dot { border-color: #f5a623; background: #2a1f00; }
.tl-propose .tl-dot { border-color: #3498db; background: #0a1a2a; }
.tl-receive .tl-dot { border-color: #3498db; background: #0a1a2a; }
.tl-counter .tl-dot { border-color: #f5a623; background: #2a1f00; }
.tl-accept .tl-dot { border-color: #2d9c3c; background: #0a1a0a; }
.tl-sign .tl-dot { border-color: #2d9c3c; background: #0a1a0a; }
.tl-pay .tl-dot { border-color: #2d9c3c; background: #0a1a0a; }
.tl-reject .tl-dot { border-color: #e74c3c; background: #1a0a0a; }
.tl-doc .tl-dot { border-color: #8e44ad; background: #1a0a1a; }
.tl-tool .tl-dot { border-color: #8e44ad; background: #1a0a1a; }
.tl-message .tl-dot { border-color: #555; background: #111; }

/* ── Bottom Sheet ───────────────────────────── */
.bottom-sheet {
  position: fixed;
  bottom: 0; left: 0; right: 0;
  background: #1a1a1a;
  border-top: 1px solid #333;
  border-radius: 16px 16px 0 0;
  z-index: 80;
  transform: translateY(100%);
  transition: transform 0.3s ease-out;
  max-height: 50vh;
  overflow-y: auto;
}
.bottom-sheet.visible {
  transform: translateY(0);
}
.handle-bar {
  display: flex;
  justify-content: center;
  padding: 10px;
  cursor: pointer;
}
.handle-bar::after {
  content: "";
  width: 40px;
  height: 4px;
  background: #444;
  border-radius: 2px;
}
.bottom-sheet-content {
  padding: 0 20px 24px;
}
#sheetDocTitle {
  font-size: 18px;
  font-weight: bold;
  color: #e0e0e0;
  margin-bottom: 8px;
}
#sheetDocSummary {
  font-size: 13px;
  color: #888;
  line-height: 1.5;
  margin-bottom: 8px;
}
#sheetSigStatus {
  font-size: 12px;
  color: #f5a623;
  margin-bottom: 16px;
}
.sheet-buttons {
  display: flex;
  gap: 10px;
}
.sign-btn {
  flex: 1;
  background: #2d9c3c;
  color: white;
  border: none;
  padding: 14px;
  font-size: 16px;
  font-family: inherit;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
}
.sign-btn:hover { background: #238b31; }
.sign-btn:disabled { background: #333; cursor: default; color: #666; }
.view-full-btn {
  background: #222;
  color: #aaa;
  border: 1px solid #333;
  padding: 14px 20px;
  font-size: 14px;
  font-family: inherit;
  border-radius: 8px;
  cursor: pointer;
}
.view-full-btn:hover { background: #2a2a2a; color: #e0e0e0; }

/* ── Document Overlay (full modal) ──────────── */
#documentOverlay {
  display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.85); z-index: 100;
  justify-content: center; align-items: center;
}
#documentModal {
  background: #111; border: 1px solid #333; border-radius: 8px;
  padding: 24px; max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto;
  position: relative;
}
#documentModal h2 { color: #2d9c3c; margin-bottom: 16px; }
#documentContent { line-height: 1.6; margin-bottom: 16px; }
#documentContent h1, #documentContent h2, #documentContent h3 { color: #e0e0e0; margin: 12px 0 8px; }
#documentContent strong { color: #fff; }
#documentContent ul, #documentContent ol { margin-left: 20px; }
#signatureStatus { color: #f5a623; margin-bottom: 12px; font-size: 14px; }
#signBtn {
  background: #2d9c3c; color: white; border: none; padding: 12px 24px;
  font-size: 16px; font-family: inherit; border-radius: 4px; cursor: pointer;
}
#signBtn:disabled { background: #333; cursor: default; }
#documentOverlay.completed #signatureStatus { color: #2d9c3c; }
#closeDocBtn {
  position: absolute;
  top: 16px; right: 16px;
  background: none;
  border: none;
  color: #888;
  font-size: 20px;
  cursor: pointer;
}
#closeDocBtn:hover { color: #e0e0e0; }

/* ── Milestones ────────────────────────────── */
#milestonesSection {
  margin-top: 16px;
  border-top: 1px solid #222;
  padding-top: 12px;
}
#milestonesSection h3 {
  font-size: 14px;
  color: #888;
  margin-bottom: 10px;
  text-transform: uppercase;
  letter-spacing: 1px;
}
.milestone-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  background: #1a1a1a;
  border: 1px solid #222;
  border-radius: 6px;
  margin-bottom: 8px;
}
.milestone-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: #f5a623;
  flex-shrink: 0;
}
.milestone-dot.completed {
  background: #2d9c3c;
}
.milestone-info {
  flex: 1;
  min-width: 0;
}
.milestone-desc {
  font-size: 13px;
  color: #e0e0e0;
  margin-bottom: 2px;
}
.milestone-condition {
  font-size: 11px;
  color: #666;
}
.milestone-amount {
  font-size: 13px;
  color: #f5a623;
  font-weight: 600;
  white-space: nowrap;
}
.milestone-amount.completed {
  color: #2d9c3c;
}
.milestone-complete-btn {
  background: #2d9c3c;
  color: white;
  border: none;
  padding: 6px 12px;
  font-size: 12px;
  font-family: inherit;
  border-radius: 4px;
  cursor: pointer;
  white-space: nowrap;
}
.milestone-complete-btn:hover { background: #238b31; }
.milestone-complete-btn:disabled { background: #333; color: #666; cursor: default; }
#sheetMilestones {
  font-size: 12px;
  color: #888;
  margin-bottom: 8px;
}
.factor-tag {
  display: inline-block;
  background: #1a2a1a;
  border: 1px solid #2d9c3c33;
  color: #aaa;
  font-size: 11px;
  padding: 2px 8px;
  border-radius: 12px;
  margin: 2px 4px 2px 0;
}
.range-item {
  font-size: 13px;
  color: #ccc;
  margin-bottom: 6px;
  padding: 6px 8px;
  background: #141414;
  border-radius: 4px;
  border-left: 3px solid #f5a623;
}
.range-item .range-amount {
  color: #f5a623;
  font-weight: 600;
}
#myContractsBtn:hover { color: #e0e0e0; border-color: #555; }

/* ── Contracts Page ──────────────────────────── */
#contracts {
  display: none;
  flex-direction: column;
  min-height: 100vh;
  background: #0a0a0a;
}
.contracts-header {
  display: flex;
  align-items: center;
  padding: 16px 20px;
  background: #111;
  border-bottom: 1px solid #222;
}
.contracts-header h2 {
  flex: 1;
  font-size: 18px;
  color: #e0e0e0;
}
#contractsBackBtn {
  background: none;
  border: 1px solid #333;
  color: #888;
  padding: 6px 14px;
  font-size: 13px;
  font-family: inherit;
  border-radius: 4px;
  cursor: pointer;
}
#contractsBackBtn:hover { color: #e0e0e0; border-color: #555; }
.contracts-list {
  flex: 1;
  overflow-y: auto;
  padding: 16px 20px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}
.contracts-empty {
  text-align: center;
  color: #555;
  padding: 60px 20px;
  font-size: 15px;
}
.contract-card {
  background: #141414;
  border: 1px solid #222;
  border-radius: 8px;
  padding: 16px;
}
.contract-card-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
}
.contract-card-title {
  flex: 1;
  font-size: 15px;
  font-weight: 600;
  color: #e0e0e0;
}
.contract-card-date {
  font-size: 11px;
  color: #555;
  white-space: nowrap;
}
.contract-card-parties {
  font-size: 12px;
  color: #888;
  margin-bottom: 10px;
}
.contract-card-amount {
  font-size: 20px;
  font-weight: 700;
  color: #e0e0e0;
  margin-bottom: 10px;
}
.contract-milestones {
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.contract-milestone-row {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 10px;
  background: #1a1a1a;
  border-radius: 4px;
}
.ms-status-dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}
.ms-status-dot.pending { background: #f5a623; }
.ms-status-dot.verifying { background: #3498db; animation: pulse-dot 1s infinite; }
.ms-status-dot.completed { background: #2d9c3c; }
.ms-status-dot.failed { background: #e74c3c; }
.ms-status-dot.disputed { background: #8e44ad; }
.contract-ms-desc {
  flex: 1;
  font-size: 12px;
  color: #ccc;
  min-width: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.contract-ms-amount {
  font-size: 12px;
  color: #888;
  white-space: nowrap;
}
.verify-btn {
  background: #1a2a3a;
  color: #3498db;
  border: 1px solid #3498db44;
  padding: 4px 10px;
  font-size: 11px;
  font-family: inherit;
  border-radius: 4px;
  cursor: pointer;
  white-space: nowrap;
}
.verify-btn:hover { background: #1a3a4a; border-color: #3498db88; }
.verify-btn:disabled { opacity: 0.5; cursor: default; }
.ms-status-badge {
  font-size: 11px;
  white-space: nowrap;
  padding: 2px 8px;
  border-radius: 10px;
}
.ms-status-badge.completed { background: #0a1a0a; color: #2d9c3c; }
.ms-status-badge.failed { background: #1a0a0a; color: #e74c3c; }
.ms-status-badge.disputed { background: #1a0a1a; color: #8e44ad; }
.ms-status-badge.verifying { background: #0a1a2a; color: #3498db; }
.contract-view-btn {
  margin-top: 10px;
  background: #1a1a1a;
  color: #888;
  border: 1px solid #333;
  padding: 8px;
  font-size: 12px;
  font-family: inherit;
  border-radius: 4px;
  cursor: pointer;
  width: 100%;
}
.contract-view-btn:hover { color: #e0e0e0; border-color: #555; }

/* ── Verification Modal ──────────────────────── */
#verificationOverlay {
  display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.85); z-index: 110;
  justify-content: center; align-items: center;
}
#verificationModal {
  background: #111; border: 1px solid #333; border-radius: 8px;
  padding: 24px; max-width: 480px; width: 90%; max-height: 80vh; overflow-y: auto;
  position: relative;
}
#closeVerifyBtn {
  position: absolute; top: 16px; right: 16px;
  background: none; border: none; color: #888; font-size: 20px; cursor: pointer;
}
#closeVerifyBtn:hover { color: #e0e0e0; }
#verifyMsTitle {
  font-size: 16px; font-weight: 600; color: #e0e0e0; margin-bottom: 4px;
}
#verifyMsCondition {
  font-size: 13px; color: #888; margin-bottom: 16px;
}
.verify-input-group {
  display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px;
}
.verify-input-group label {
  font-size: 12px; color: #888;
}
.verify-input-group input {
  background: #1a1a1a; border: 1px solid #333; color: #e0e0e0;
  padding: 10px 12px; font-size: 14px; font-family: inherit; border-radius: 6px;
}
.verify-input-group input:focus { border-color: #3498db; outline: none; }
#startVerifyBtn {
  background: #1a2a3a; color: #3498db; border: 1px solid #3498db44;
  padding: 12px; font-size: 15px; font-family: inherit; border-radius: 6px;
  cursor: pointer; width: 100%; font-weight: 600;
}
#startVerifyBtn:hover { background: #1a3a4a; border-color: #3498db88; }
#startVerifyBtn:disabled { opacity: 0.5; cursor: default; }
.verify-progress {
  display: none; flex-direction: column; gap: 8px; margin-top: 16px;
}
.verify-step {
  display: flex; align-items: center; gap: 10px;
  padding: 8px 0;
}
.verify-step-dot {
  width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0;
  background: #333;
}
.verify-step-dot.active { background: #3498db; animation: pulse-dot 1s infinite; }
.verify-step-dot.done { background: #2d9c3c; }
.verify-step-text {
  font-size: 13px; color: #888;
}
.verify-step-dot.active + .verify-step-text { color: #e0e0e0; }
.verify-step-dot.done + .verify-step-text { color: #aaa; }
.verify-result {
  display: none; margin-top: 16px; padding: 16px;
  border-radius: 6px; border: 1px solid #333;
}
.verify-result.passed { background: #0a1a0a; border-color: #2d9c3c44; }
.verify-result.failed { background: #1a0a0a; border-color: #e74c3c44; }
.verify-result.disputed { background: #1a0a1a; border-color: #8e44ad44; }
.verify-result-status {
  font-size: 18px; font-weight: 700; margin-bottom: 8px;
}
.verify-result.passed .verify-result-status { color: #2d9c3c; }
.verify-result.failed .verify-result-status { color: #e74c3c; }
.verify-result.disputed .verify-result-status { color: #8e44ad; }
.verify-result-reasoning {
  font-size: 13px; color: #aaa; line-height: 1.5; margin-bottom: 10px;
}
.verify-evidence-list {
  display: flex; flex-direction: column; gap: 4px;
}
.verify-evidence-item {
  font-size: 11px; color: #666; padding: 4px 0;
  border-top: 1px solid #222;
}
.verify-evidence-item:first-child { border-top: none; }
.verify-result-amount {
  font-size: 14px; color: #e0e0e0; margin-top: 8px; font-weight: 600;
}

/* ── Mobile ─────────────────────────────────── */
@media (max-width: 768px) {
  .expanded-body { flex-direction: column; }
  .transcript-dual { border-right: none; border-bottom: 1px solid #222; height: 50%; flex-shrink: 0; }
  .workflow-timeline { height: 50%; }
  .top-bar { padding: 10px 14px; }
  #peerName { font-size: 14px; }
  #callTimer { font-size: 16px; }
  #expandBtn { padding: 4px 10px; font-size: 12px; }
}
</style>
</head>
<body>

<!-- Setup Screen -->
<div id="setup">
  <button id="gearBtn" title="Settings">&#9881;</button>
  <h1>Handshake</h1>
  <p class="tagline">Voice-powered agreements</p>
  <form id="profileForm">
    <input id="displayName" placeholder="Your name" required />
    <div class="room-row">
      <input id="roomCode" placeholder="Room code" />
      <button type="button" id="copyRoomBtn" title="Copy room code">&#128203;</button>
    </div>
    <button type="submit">Join Room</button>
  </form>
  <button id="myContractsBtn" style="
    background:none; border:1px solid #333; color:#888; padding:10px 20px;
    font-size:14px; font-family:inherit; border-radius:6px; cursor:pointer;
    margin-top:12px; width:100%; max-width:340px; transition:color 0.2s, border-color 0.2s;
  ">My Contracts</button>
  <p id="setupStatus"></p>
</div>

<!-- Settings Drawer Overlay -->
<div id="drawerOverlay"></div>

<!-- Settings Drawer -->
<div id="settingsDrawer">
  <div class="drawer-header">
    <h2>Settings</h2>
    <button id="closeDrawerBtn">&times;</button>
  </div>
  <div class="drawer-body">
    <h3>Your Role</h3>
    <input id="role" placeholder="e.g., landlord, plumber, freelancer" />

    <h3>Agent Preferences</h3>
    <label>Style:
      <select id="negStyle">
        <option value="balanced">Balanced</option>
        <option value="aggressive">Aggressive</option>
        <option value="conservative">Conservative</option>
      </select>
    </label>
    <label>Currency:
      <select id="currency">
        <option value="gbp">GBP</option>
        <option value="usd">USD</option>
        <option value="eur">EUR</option>
      </select>
    </label>
    <label>Max auto-approve:
      <div class="currency-prefix">
        <span id="currencySymbol">&pound;</span>
        <input id="maxApprove" type="number" value="50" min="0" step="1" />
      </div>
    </label>
    <label>Escrow:
      <select id="escrowPref">
        <option value="above_threshold">Above threshold</option>
        <option value="always">Always</option>
        <option value="never">Never</option>
      </select>
    </label>
    <label>Escrow threshold:
      <div class="currency-prefix">
        <span id="escrowSymbol">&pound;</span>
        <input id="escrowThreshold" type="number" value="100" min="0" step="1" />
      </div>
    </label>

    <h3>Professional Profile</h3>
    <input id="trade" placeholder="Trade (e.g., plumber, electrician)" />
    <label>Experience (years):
      <input id="experienceYears" type="number" min="0" max="100" step="1" placeholder="0" />
    </label>
    <input id="certifications" placeholder="Certifications (comma-separated)" />
    <label>Typical rate range:
      <div style="display:flex;gap:6px;align-items:center;">
        <div class="currency-prefix" style="flex:1;">
          <span>&pound;</span>
          <input id="rateMin" type="number" min="0" step="1" placeholder="Min" />
        </div>
        <span style="color:#555;">–</span>
        <div class="currency-prefix" style="flex:1;">
          <span>&pound;</span>
          <input id="rateMax" type="number" min="0" step="1" placeholder="Max" />
        </div>
        <select id="rateUnit" style="width:auto;padding:10px 8px;font-size:13px;">
          <option value="hour">/hr</option>
          <option value="day">/day</option>
          <option value="job">/job</option>
        </select>
      </div>
    </label>
    <input id="serviceArea" placeholder="Service area (e.g., London, SE England)" />
    <label>Upload docs (.txt, .md — max 5KB each):
      <input id="docUpload" type="file" accept=".txt,.md" multiple style="padding:8px;" />
    </label>

    <h3>Instructions</h3>
    <textarea id="customInstructions" placeholder="Tell your agent how to negotiate for you..."></textarea>

    <h3>Payment</h3>
    <input id="stripeId" placeholder="Stripe Connect ID (acct_...)" />
    <input id="monzoToken" placeholder="Monzo access token" type="password" />
  </div>
</div>

<!-- Session Screen -->
<div id="session" style="display: none;">

  <!-- Default View -->
  <div id="defaultView" style="display:flex; flex-direction:column; flex:1;">
    <div class="top-bar">
      <div class="top-bar-left">
        <span id="myNameLabel" style="font-size:13px;color:#888;"></span>
      </div>
      <div class="top-bar-center">
        <span id="callTimer">00:00</span>
      </div>
      <div class="top-bar-right">
        <div class="status-dot waiting" id="statusDot"></div>
        <span id="peerName" style="font-size:13px;color:#888;">Waiting...</span>
      </div>
    </div>
    <div class="call-center">
      <div class="pulse-ring"><div class="pulse-ring-inner"></div></div>
      <div id="callPeerName"></div>
      <div id="callPeerRole"></div>
      <div id="callStatusText">Listening...</div>
      <div id="negSummaryCard" class="neg-summary-card">
        <div class="neg-summary-title">Negotiation</div>
        <div id="negSummaryAmount" class="neg-summary-amount"></div>
        <div id="negSummaryDetail" class="neg-summary-detail"></div>
      </div>
      <div id="receiptCard" class="receipt-card">
        <div class="receipt-header">Payment</div>
        <div id="receiptItems"></div>
      </div>
    </div>
    <div class="call-action-bar">
      <button class="call-action-btn" id="muteBtnAction" title="Mute microphone">&#127908;</button>
      <button class="call-action-btn" id="speakerBtnAction" title="Hear peer audio">&#128264;</button>
      <button class="call-action-btn" id="detailsBtnAction" title="View details">&#128196;</button>
      <button class="call-action-btn end" id="endCallBtn" title="Leave call">&#128383;</button>
    </div>
  </div>

  <!-- Expanded View -->
  <div id="expandedView" class="expanded-view">
    <div class="expanded-header">
      <h2>Session Details</h2>
      <button id="collapseBtn">&times;</button>
    </div>
    <div class="expanded-body">
      <div class="transcript-dual">
        <div class="transcript-col">
          <div class="transcript-col-header" id="colHeaderA">You</div>
          <div class="transcript-col-content" id="colContentA"></div>
        </div>
        <div class="transcript-divider"></div>
        <div class="transcript-col">
          <div class="transcript-col-header" id="colHeaderB">Peer</div>
          <div class="transcript-col-content" id="colContentB"></div>
        </div>
      </div>
      <div class="workflow-timeline">
        <div class="workflow-timeline-header">Agent Timeline</div>
        <div id="timelineContent"></div>
      </div>
    </div>
  </div>

  <!-- Bottom Sheet (document summary) -->
  <div id="bottomSheet" class="bottom-sheet">
    <div class="handle-bar" id="sheetHandle"></div>
    <div class="bottom-sheet-content">
      <div id="sheetDocTitle"></div>
      <div id="sheetDocSummary"></div>
      <div id="sheetFactors"></div>
      <div id="sheetSigStatus"></div>
      <div id="sheetMilestones"></div>
      <div class="sheet-buttons">
        <button class="sign-btn" id="docSignBtn">Sign Agreement</button>
        <button class="view-full-btn" id="docViewFull">View Full</button>
      </div>
    </div>
  </div>

  <!-- Document Overlay (full modal) -->
  <div id="documentOverlay" style="display: none;">
    <div id="documentModal">
      <button id="closeDocBtn">&times;</button>
      <h2 id="documentTitle"></h2>
      <div id="documentContent"></div>
      <div id="signatureStatus"></div>
      <button id="signBtn">Sign Agreement</button>
      <div id="milestonesSection" style="display:none;">
        <h3>Milestones</h3>
        <div id="milestonesList"></div>
      </div>
    </div>
  </div>
</div>

<!-- Contracts Page -->
<div id="contracts">
  <div class="contracts-header">
    <h2>My Contracts</h2>
    <button id="contractsBackBtn">Back</button>
  </div>
  <div class="contracts-list" id="contractsList"></div>
</div>

<!-- Verification Modal -->
<div id="verificationOverlay">
  <div id="verificationModal">
    <button id="closeVerifyBtn">&times;</button>
    <div id="verifyMsTitle"></div>
    <div id="verifyMsCondition"></div>
    <div class="verify-input-group" id="verifyInputGroup">
      <label>Phone number (optional — enables AI phone verification)</label>
      <input id="verifyPhone" type="tel" placeholder="+44 7..." />
      <label>Contact name</label>
      <input id="verifyContactName" placeholder="Who should we call?" />
    </div>
    <button id="startVerifyBtn">Start Verification</button>
    <div class="verify-progress" id="verifyProgress"></div>
    <div class="verify-result" id="verifyResult">
      <div class="verify-result-status" id="verifyResultStatus"></div>
      <div class="verify-result-reasoning" id="verifyResultReasoning"></div>
      <div class="verify-result-amount" id="verifyResultAmount"></div>
      <div class="verify-evidence-list" id="verifyEvidenceList"></div>
    </div>
  </div>
</div>

<script>
// ── Profile Persistence ──────────────────────

const PROFILE_KEY = "handshake_profile";

function loadProfile() {
  try {
    const saved = localStorage.getItem(PROFILE_KEY);
    if (saved) {
      const profile = JSON.parse(saved);
      document.getElementById("displayName").value = profile.displayName ?? "";
      document.getElementById("role").value = profile.role ?? "";
      document.getElementById("customInstructions").value = profile.customInstructions ?? "";
      document.getElementById("maxApprove").value = String((profile.preferences?.maxAutoApproveAmount ?? 5000) / 100);
      document.getElementById("currency").value = profile.preferences?.preferredCurrency ?? "gbp";
      document.getElementById("escrowPref").value = profile.preferences?.escrowPreference ?? "above_threshold";
      document.getElementById("escrowThreshold").value = String((profile.preferences?.escrowThreshold ?? 10000) / 100);
      document.getElementById("negStyle").value = profile.preferences?.negotiationStyle ?? "balanced";
      document.getElementById("stripeId").value = profile.stripeAccountId ?? "acct_1T3QGEC93jdq27di";
      // Professional profile fields
      document.getElementById("trade").value = profile.trade ?? "";
      document.getElementById("experienceYears").value = profile.experienceYears != null ? String(profile.experienceYears) : "";
      document.getElementById("certifications").value = Array.isArray(profile.certifications) ? profile.certifications.join(", ") : "";
      if (profile.typicalRateRange) {
        document.getElementById("rateMin").value = String((profile.typicalRateRange.min ?? 0) / 100);
        document.getElementById("rateMax").value = String((profile.typicalRateRange.max ?? 0) / 100);
        document.getElementById("rateUnit").value = profile.typicalRateRange.unit ?? "hour";
      }
      document.getElementById("serviceArea").value = profile.serviceArea ?? "";
    }
  } catch { /* ignore parse errors */ }
}

function buildProfile() {
  const trade = document.getElementById("trade").value.trim() || undefined;
  const expVal = document.getElementById("experienceYears").value;
  const experienceYears = expVal !== "" ? Number(expVal) : undefined;
  const certsRaw = document.getElementById("certifications").value.trim();
  const certifications = certsRaw ? certsRaw.split(",").map(c => c.trim()).filter(Boolean) : undefined;
  const rateMin = Number(document.getElementById("rateMin").value) || 0;
  const rateMax = Number(document.getElementById("rateMax").value) || 0;
  const rateUnit = document.getElementById("rateUnit").value;
  const typicalRateRange = rateMax > 0 ? { min: Math.round(rateMin * 100), max: Math.round(rateMax * 100), unit: rateUnit } : undefined;
  const serviceArea = document.getElementById("serviceArea").value.trim() || undefined;

  const profile = {
    displayName: document.getElementById("displayName").value.trim(),
    role: document.getElementById("role").value.trim() || "participant",
    customInstructions: document.getElementById("customInstructions").value.trim(),
    preferences: {
      maxAutoApproveAmount: Math.round(Number(document.getElementById("maxApprove").value) * 100),
      preferredCurrency: document.getElementById("currency").value,
      escrowPreference: document.getElementById("escrowPref").value,
      escrowThreshold: Math.round(Number(document.getElementById("escrowThreshold").value) * 100),
      negotiationStyle: document.getElementById("negStyle").value,
    },
    stripeAccountId: document.getElementById("stripeId").value.trim() || undefined,
    monzoAccessToken: document.getElementById("monzoToken").value.trim() || undefined,
    trade,
    experienceYears,
    certifications,
    typicalRateRange,
    serviceArea,
    contextDocuments: uploadedDocs.length > 0 ? [...uploadedDocs] : undefined,
  };
  const toSave = { ...profile };
  delete toSave.monzoAccessToken;
  delete toSave.contextDocuments; // don't persist docs in localStorage
  localStorage.setItem(PROFILE_KEY, JSON.stringify(toSave));
  return profile;
}

// ── Document Upload Handling ────────────────
let uploadedDocs = [];

document.getElementById("docUpload").addEventListener("change", async (e) => {
  uploadedDocs = [];
  const files = e.target.files;
  for (const file of files) {
    if (file.size > 5120) {
      console.warn(`Skipping ${file.name}: exceeds 5KB limit`);
      continue;
    }
    try {
      const text = await file.text();
      uploadedDocs.push(text.slice(0, 5120));
    } catch { /* skip unreadable files */ }
  }
});

// ── Room Code Generation ─────────────────────

function generateRoomCode() {
  const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
  let code = "";
  for (let i = 0; i < 6; i++) {
    code += chars[Math.floor(Math.random() * chars.length)];
  }
  return code;
}

// ── User ID Generation ───────────────────────

function generateUserId(name) {
  const sanitized = name.toLowerCase().replace(/[^a-z0-9]/g, "");
  const suffix = Math.random().toString(36).slice(2, 6);
  return `${sanitized}-${suffix}`;
}

// ── Utilities ────────────────────────────────

function formatTime(ts) {
  const d = new Date(ts);
  return d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", second: "2-digit" });
}

function autoScroll(container) {
  const isNearBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 100;
  if (isNearBottom) {
    container.scrollTop = container.scrollHeight;
  }
}

function escapeHtml(str) {
  return str
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

function markdownToHtml(md) {
  return escapeHtml(md)
    .replace(/^### (.+)$/gm, "<h3>$1</h3>")
    .replace(/^## (.+)$/gm, "<h2>$1</h2>")
    .replace(/^# (.+)$/gm, "<h1>$1</h1>")
    .replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>")
    .replace(/\*(.+?)\*/g, "<em>$1</em>")
    .replace(/^- (.+)$/gm, "<li>$1</li>")
    .replace(/(<li>.*<\/li>)/s, "<ul>$1</ul>")
    .replace(/^\d+\. (.+)$/gm, "<li>$1</li>")
    .replace(/\n\n/g, "<br><br>")
    .replace(/\n/g, "<br>");
}

function derivePeerName(userId) {
  const seg = userId.split("-")[0] || userId;
  return seg.charAt(0).toUpperCase() + seg.slice(1);
}

// ── Session State ────────────────────────────

let myUserId = null;
let myDisplayName = null;
let peerDisplayName = null;
let peerUserId = null;
let callStartTime = null;
let callTimerInterval = null;
let expandedViewOpen = false;
let audioRelayEnabled = false;

const transcriptBuffer = [];
const timelineNodes = [];
let currentDocument = null;
let panelWsRef = null;
const milestoneMap = new Map(); // milestoneId → milestone object
const mySignedDocuments = new Set(); // track docs this user has signed locally
let lastBottomSheetDocId = null;

// ── Call Timer ───────────────────────────────

function startCallTimer() {
  if (callTimerInterval) return;
  callStartTime = Date.now();
  callTimerInterval = setInterval(updateCallTimer, 1000);
  updateCallTimer();
}

function updateCallTimer() {
  const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
  const mins = String(Math.floor(elapsed / 60)).padStart(2, "0");
  const secs = String(elapsed % 60).padStart(2, "0");
  document.getElementById("callTimer").textContent = `${mins}:${secs}`;
}

// ── Expanded View Toggle ─────────────────────

function openExpandedView() {
  expandedViewOpen = true;
  const el = document.getElementById("expandedView");
  el.style.display = "flex";
  renderFullTranscript();
  renderFullTimeline();
  autoScroll(document.getElementById("colContentA"));
  autoScroll(document.getElementById("colContentB"));
  autoScroll(document.getElementById("timelineContent"));
}

function closeExpandedView() {
  expandedViewOpen = false;
  document.getElementById("expandedView").style.display = "none";
}

document.getElementById("collapseBtn").addEventListener("click", closeExpandedView);

// ── Rendering Helpers ────────────────────────

function renderTranscriptEntry(entry) {
  const isLocal = entry.isLocal;
  const col = isLocal
    ? document.getElementById("colContentA")
    : document.getElementById("colContentB");

  const div = document.createElement("div");
  div.className = "t-bubble" + (isLocal ? "" : " t-bubble-peer") + (entry.isPartial ? " t-bubble-partial" : "");
  div.dataset.ts = String(entry.timestamp);
  if (entry.isPartial) div.dataset.partialSpeaker = entry.speaker;

  const text = document.createElement("span");
  text.textContent = entry.text;
  div.appendChild(text);

  if (!entry.isPartial) {
    const time = document.createElement("span");
    time.className = "t-bubble-time";
    time.textContent = formatTime(entry.timestamp);
    div.appendChild(time);
  }

  // Insert in timestamp order
  const existing = col.querySelectorAll(".t-bubble:not(.t-bubble-partial)");
  let inserted = false;
  if (!entry.isPartial) {
    for (let i = existing.length - 1; i >= 0; i--) {
      if (Number(existing[i].dataset.ts) <= entry.timestamp) {
        existing[i].after(div);
        inserted = true;
        break;
      }
    }
  }
  if (!inserted) col.appendChild(div);

  autoScroll(col);
}

function renderFullTranscript() {
  document.getElementById("colContentA").innerHTML = "";
  document.getElementById("colContentB").innerHTML = "";
  for (const entry of transcriptBuffer) {
    if (!entry.isPartial) renderTranscriptEntry(entry);
  }
}

function renderTimelineNode(node) {
  const container = document.getElementById("timelineContent");
  const div = document.createElement("div");
  div.className = `tl-node tl-${node.type}`;

  const dot = document.createElement("div");
  dot.className = "tl-dot";

  const text = document.createElement("div");
  text.className = "tl-text";
  text.textContent = node.text;

  const time = document.createElement("div");
  time.className = "tl-time";
  time.textContent = formatTime(node.timestamp);

  div.appendChild(dot);
  div.appendChild(text);
  div.appendChild(time);
  container.appendChild(div);
  autoScroll(container);
}

function renderFullTimeline() {
  document.getElementById("timelineContent").innerHTML = "";
  for (const node of timelineNodes) {
    renderTimelineNode(node);
  }
}

// ── Message Handlers ─────────────────────────

function handleTranscript(msg, userId) {
  const entry = msg.entry;
  const isLocal = entry.speaker === userId || entry.source === "local";

  if (!entry.isFinal) {
    // Handle partials — update or create temporary bubble
    if (expandedViewOpen) {
      const col = isLocal
        ? document.getElementById("colContentA")
        : document.getElementById("colContentB");
      let partial = col.querySelector(`[data-partial-speaker="${entry.speaker}"]`);
      if (!partial) {
        renderTranscriptEntry({
          speaker: entry.speaker,
          text: entry.text + "...",
          timestamp: entry.timestamp || Date.now(),
          isLocal,
          isPartial: true,
        });
      } else {
        partial.querySelector("span").textContent = entry.text + "...";
      }
    }
    return;
  }

  // Remove partial for this speaker
  if (expandedViewOpen) {
    const col = isLocal
      ? document.getElementById("colContentA")
      : document.getElementById("colContentB");
    const partial = col.querySelector(`[data-partial-speaker="${entry.speaker}"]`);
    if (partial) partial.remove();
  }

  // Buffer final entry
  const bufferEntry = {
    speaker: entry.speaker,
    text: entry.text,
    timestamp: entry.timestamp || Date.now(),
    isLocal,
    isPartial: false,
  };
  transcriptBuffer.push(bufferEntry);

  // Render if expanded
  if (expandedViewOpen) {
    renderTranscriptEntry(bufferEntry);
  }
}

function handleAgent(msg) {
  let type = "message";
  let text = msg.text;

  if (text.startsWith("[Tool:")) {
    type = "tool";
    const nameMatch = text.match(/\[Tool: (.+?)\]/);
    const toolName = nameMatch ? nameMatch[1] : "unknown";
    const result = text.replace(/\[Tool: .+?\] ?/, "");
    text = `${toolName}: ${result}`;
  } else if (/\[Smart Detection\].*TRIGGERED/i.test(text)) {
    type = "detect";
  }

  // Truncate to ~100 chars
  if (text.length > 100) text = text.slice(0, 97) + "...";

  const node = { type, text, timestamp: Date.now() };
  timelineNodes.push(node);

  if (expandedViewOpen) {
    renderTimelineNode(node);
  }
}

function handleNegotiation(msg) {
  const neg = msg.negotiation;
  const statusMap = {
    proposed: "propose",
    countering: "counter",
    accepted: "accept",
    rejected: "reject",
    executing: "pay",
  };
  const type = statusMap[neg.status] || "message";
  const amount = neg.currentProposal
    ? ` \u00A3${(neg.currentProposal.totalAmount / 100).toFixed(2)}`
    : "";
  const text = `${neg.status.toUpperCase()} (Round ${neg.rounds.length}/${neg.maxRounds})${amount}`;

  const node = { type, text, timestamp: Date.now() };
  timelineNodes.push(node);

  if (expandedViewOpen) {
    renderTimelineNode(node);
  }

  // Update default view status text
  const statusText = document.getElementById("callStatusText");
  const negCard = document.getElementById("negSummaryCard");
  switch (neg.status) {
    case "proposed":
      statusText.textContent = "Negotiating...";
      break;
    case "countering":
      statusText.textContent = "Counter-offer...";
      break;
    case "accepted":
      statusText.textContent = "Agreement reached";
      break;
    case "rejected":
      statusText.textContent = "Proposal rejected";
      negCard.classList.remove("visible");
      break;
    case "executing":
      statusText.textContent = "Processing payment...";
      break;
  }

  // Show negotiation summary card
  if (neg.currentProposal && neg.status !== "rejected") {
    negCard.classList.add("visible");
    const sym = CURRENCY_SYMBOLS[neg.currentProposal.currency] || "\u00A3";
    document.getElementById("negSummaryAmount").textContent =
      `${sym}${(neg.currentProposal.totalAmount / 100).toFixed(2)}`;
    const round = neg.rounds.length > 0 ? neg.rounds[neg.rounds.length - 1] : null;
    const action = round ? round.action : neg.status;
    const detail = `${neg.currentProposal.lineItems.length} item${neg.currentProposal.lineItems.length !== 1 ? "s" : ""} \u2022 Round ${neg.rounds.length}/${neg.maxRounds} \u2022 ${action}`;
    document.getElementById("negSummaryDetail").textContent = detail;
  }
}

function handleExecution(msg) {
  const isSign = msg.step && msg.step.toLowerCase().includes("signature");
  const type = isSign ? "sign" : "pay";
  const text = `${msg.step}: ${msg.status}${msg.details ? " \u2014 " + msg.details : ""}`;

  const node = { type, text: text.length > 100 ? text.slice(0, 97) + "..." : text, timestamp: Date.now() };
  timelineNodes.push(node);

  if (expandedViewOpen) {
    renderTimelineNode(node);
  }
}

function handleDocument(msg, panelWs) {
  const doc = msg.document;
  currentDocument = doc;

  // Save contract to localStorage
  saveContract(doc);

  // Add timeline node
  const node = { type: "doc", text: `Document: ${doc.title}`, timestamp: Date.now() };
  timelineNodes.push(node);
  if (expandedViewOpen) renderTimelineNode(node);

  // Populate bottom sheet
  document.getElementById("sheetDocTitle").textContent = doc.title;
  const summary = doc.content.length > 200 ? doc.content.slice(0, 200) + "..." : doc.content;
  document.getElementById("sheetDocSummary").textContent = summary;
  updateBottomSheetSignatureStatus(doc);
  renderFactorSummary(doc);

  // Wire sign button (preserve signed state across re-broadcasts)
  const signBtn = document.getElementById("docSignBtn");
  const alreadySigned = mySignedDocuments.has(doc.id) ||
    doc.signatures.some(s => s.userId === myUserId);

  if (alreadySigned || doc.status === "fully_signed") {
    signBtn.disabled = true;
    signBtn.textContent = doc.status === "fully_signed" ? "Fully Signed \u2713" : "Signed \u2713";
  } else {
    signBtn.disabled = false;
    signBtn.textContent = "Sign Agreement";
    signBtn.onclick = () => {
      panelWs.send(JSON.stringify({ type: "sign_document", documentId: doc.id }));
      mySignedDocuments.add(doc.id);
      signBtn.disabled = true;
      signBtn.textContent = "Signed \u2713";
      saveContract({ ...doc, signatures: [...doc.signatures, { userId: myUserId, signedAt: Date.now() }] });
    };
  }

  // Wire view-full button
  document.getElementById("docViewFull").onclick = () => {
    showDocumentOverlay(doc, panelWs);
  };

  // Only slide up bottom sheet for new documents, not re-broadcasts after signatures
  if (lastBottomSheetDocId !== doc.id) {
    lastBottomSheetDocId = doc.id;
    document.getElementById("bottomSheet").classList.add("visible");
  }

  // Also populate full overlay (for later)
  populateDocumentOverlay(doc, panelWs);

  // Extract milestones from document if present
  if (doc.milestones && doc.milestones.length > 0) {
    for (const ms of doc.milestones) {
      milestoneMap.set(ms.id, ms);
    }
    updateMilestonesUI(panelWs);
    const sheetMs = document.getElementById("sheetMilestones");
    const pending = doc.milestones.filter(m => m.status === "pending").length;
    sheetMs.textContent = `Milestones: ${pending} pending`;
  }

  // Update status text and auto-dismiss when fully signed
  if (doc.status === "fully_signed") {
    document.getElementById("callStatusText").textContent = "Agreement signed!";

    // Auto-dismiss bottom sheet after 3 seconds
    setTimeout(() => {
      document.getElementById("bottomSheet").classList.remove("visible");
    }, 3000);

    // Auto-dismiss document overlay after 3 seconds (if open)
    setTimeout(() => {
      const overlay = document.getElementById("documentOverlay");
      if (overlay.style.display === "flex") {
        overlay.style.display = "none";
        overlay.classList.remove("completed");
      }
    }, 3000);
  } else {
    document.getElementById("callStatusText").textContent = "Document ready for signing";
  }
}

function updateBottomSheetSignatureStatus(doc) {
  const el = document.getElementById("sheetSigStatus");
  const signed = doc.signatures.length;
  const total = doc.parties.length;
  el.textContent = `Signatures: ${signed}/${total}`;
  if (doc.status === "fully_signed") {
    el.textContent += " \u2014 Complete!";
    el.style.color = "#2d9c3c";
  }
}

function handleMilestone(msg) {
  const ms = msg.milestone;
  milestoneMap.set(ms.id, ms);

  // Update stored contract
  saveContractMilestone(ms);

  // Add timeline node
  const statusLabels = { completed: "complete", failed: "failed", disputed: "disputed", verifying: "verifying", pending: "pending" };
  const type = ms.status === "completed" ? "pay" : ms.status === "verifying" ? "tool" : "message";
  const text = `Milestone ${statusLabels[ms.status] || ms.status}: ${ms.description}`;
  const node = { type, text: text.length > 100 ? text.slice(0, 97) + "..." : text, timestamp: Date.now() };
  timelineNodes.push(node);
  if (expandedViewOpen) renderTimelineNode(node);

  // Update milestones UI if panelWs is available
  if (panelWsRef) updateMilestonesUI(panelWsRef);

  // Update bottom sheet milestone count
  const pending = [...milestoneMap.values()].filter(m => m.status === "pending").length;
  const verifying = [...milestoneMap.values()].filter(m => m.status === "verifying").length;
  const sheetMs = document.getElementById("sheetMilestones");
  if (verifying > 0) {
    sheetMs.textContent = `Milestones: ${verifying} verifying, ${pending} pending`;
  } else if (pending > 0) {
    sheetMs.textContent = `Milestones: ${pending} pending`;
  } else if (milestoneMap.size > 0) {
    sheetMs.textContent = "All milestones complete!";
    sheetMs.style.color = "#2d9c3c";
  }
}

function saveContractMilestone(ms) {
  try {
    const contracts = JSON.parse(localStorage.getItem(CONTRACTS_KEY) || "[]");
    const contractIdx = contracts.findIndex(c => c.id === ms.documentId);
    if (contractIdx >= 0 && contracts[contractIdx].milestones) {
      contracts[contractIdx].milestones = contracts[contractIdx].milestones.map(m =>
        m.id === ms.id ? ms : m
      );
      localStorage.setItem(CONTRACTS_KEY, JSON.stringify(contracts));
    }
  } catch { /* ignore */ }
}

function updateMilestonesUI(panelWs) {
  const section = document.getElementById("milestonesSection");
  const list = document.getElementById("milestonesList");
  if (milestoneMap.size === 0) {
    section.style.display = "none";
    return;
  }
  section.style.display = "block";
  list.innerHTML = "";

  for (const ms of milestoneMap.values()) {
    const item = document.createElement("div");
    item.className = "milestone-item";
    item.dataset.milestoneId = ms.id;

    const dot = document.createElement("div");
    dot.className = "milestone-dot" + (ms.status === "completed" ? " completed" : "");

    const info = document.createElement("div");
    info.className = "milestone-info";
    const desc = document.createElement("div");
    desc.className = "milestone-desc";
    desc.textContent = ms.description;
    const cond = document.createElement("div");
    cond.className = "milestone-condition";
    cond.textContent = ms.condition;
    info.appendChild(desc);
    info.appendChild(cond);

    const amount = document.createElement("div");
    amount.className = "milestone-amount" + (ms.status === "completed" ? " completed" : "");
    amount.textContent = "\u00A3" + (ms.amount / 100).toFixed(2);

    item.appendChild(dot);
    item.appendChild(info);
    item.appendChild(amount);

    if (ms.status === "pending") {
      const btn = document.createElement("button");
      btn.className = "milestone-complete-btn";
      btn.textContent = "Verify";
      btn.onclick = () => {
        openVerificationModal(currentDocument, ms);
      };
      item.appendChild(btn);
    } else if (ms.status === "verifying") {
      const badge = document.createElement("div");
      badge.style.cssText = "font-size:12px;color:#3498db;white-space:nowrap;";
      badge.textContent = "Verifying...";
      item.appendChild(badge);
    } else if (ms.status === "failed") {
      const badge = document.createElement("div");
      badge.style.cssText = "font-size:12px;color:#e74c3c;white-space:nowrap;";
      badge.textContent = "\u2717 Failed";
      item.appendChild(badge);
    } else if (ms.status === "disputed") {
      const badge = document.createElement("div");
      badge.style.cssText = "font-size:12px;color:#8e44ad;white-space:nowrap;";
      badge.textContent = "Disputed";
      item.appendChild(badge);
    } else {
      const badge = document.createElement("div");
      badge.style.cssText = "font-size:12px;color:#2d9c3c;white-space:nowrap;";
      badge.textContent = "\u2713 Done";
      item.appendChild(badge);
    }

    list.appendChild(item);
  }
}

function populateDocumentOverlay(doc, panelWs) {
  document.getElementById("documentTitle").textContent = doc.title;
  document.getElementById("documentContent").innerHTML = markdownToHtml(doc.content);
  updateSignatureStatus(doc);

  const signBtn = document.getElementById("signBtn");
  const alreadySigned = mySignedDocuments.has(doc.id) ||
    doc.signatures.some(s => s.userId === myUserId);

  if (alreadySigned || doc.status === "fully_signed") {
    signBtn.disabled = true;
    signBtn.textContent = doc.status === "fully_signed" ? "Fully Signed \u2713" : "Signed \u2713";
  } else {
    signBtn.disabled = false;
    signBtn.textContent = "Sign Agreement";
    signBtn.onclick = () => {
      panelWs.send(JSON.stringify({ type: "sign_document", documentId: doc.id }));
      mySignedDocuments.add(doc.id);
      signBtn.disabled = true;
      signBtn.textContent = "Signed \u2713";
      const sheetBtn = document.getElementById("docSignBtn");
      sheetBtn.disabled = true;
      sheetBtn.textContent = "Signed \u2713";
    };
  }
}

function showDocumentOverlay(doc, panelWs) {
  populateDocumentOverlay(doc, panelWs);
  document.getElementById("documentOverlay").style.display = "flex";
}

function updateSignatureStatus(doc) {
  const el = document.getElementById("signatureStatus");
  const signed = doc.signatures.length;
  const total = doc.parties.length;
  el.textContent = `Signatures: ${signed}/${total}`;
  if (doc.status === "fully_signed") {
    el.textContent += " \u2014 Agreement Complete!";
    document.getElementById("documentOverlay").classList.add("completed");
  }
}

function handleStatus(msg) {
  const dot = document.getElementById("statusDot");
  const peerNameEl = document.getElementById("peerName");
  const statusText = document.getElementById("callStatusText");

  if (msg.users && msg.users.length >= 2) {
    dot.className = "status-dot connected";

    // Find peer (the user that isn't me)
    const peer = msg.users.find(u => u !== myUserId);
    if (peer && peer !== peerUserId) {
      peerUserId = peer;
      peerDisplayName = derivePeerName(peer);
      peerNameEl.textContent = peerDisplayName;
      document.getElementById("colHeaderB").textContent = peerDisplayName;
      document.getElementById("callPeerName").textContent = peerDisplayName;
      document.getElementById("callPeerRole").textContent = "";
    }

    statusText.textContent = "Listening...";
    startCallTimer();
  } else {
    dot.className = "status-dot waiting";
    peerNameEl.textContent = "Waiting...";
    statusText.textContent = "Waiting for partner...";
    document.getElementById("callPeerName").textContent = "";
    document.getElementById("callPeerRole").textContent = "";
  }

  if (msg.sessionStatus === "completed") {
    statusText.textContent = "Payment complete";
  }
}

function handleError(msg) {
  document.getElementById("statusDot").className = "status-dot error";
  document.getElementById("peerName").textContent = `Error: ${msg.message}`;
  document.getElementById("callStatusText").textContent = "Connection error";
}

// ── Payment Receipt Handler ─────────────────

const receiptItems = new Map(); // description → {status, amount, currency}

function handlePaymentReceipt(msg) {
  receiptItems.set(msg.description, {
    status: msg.status,
    amount: msg.amount,
    currency: msg.currency,
    recipient: msg.recipient,
    paymentIntentId: msg.paymentIntentId,
  });

  const card = document.getElementById("receiptCard");
  card.classList.add("visible");
  const container = document.getElementById("receiptItems");
  container.innerHTML = "";

  const sym = CURRENCY_SYMBOLS[msg.currency] || "\u00A3";
  for (const [desc, item] of receiptItems) {
    const row = document.createElement("div");
    row.className = "receipt-item";

    const dot = document.createElement("div");
    dot.className = `receipt-dot ${item.status}`;

    const descEl = document.createElement("div");
    descEl.className = "receipt-desc";
    descEl.textContent = desc;

    const amtEl = document.createElement("div");
    amtEl.className = "receipt-amount";
    amtEl.textContent = `${sym}${(item.amount / 100).toFixed(2)}`;

    row.appendChild(dot);
    row.appendChild(descEl);
    row.appendChild(amtEl);

    if (item.status === "succeeded") {
      const check = document.createElement("span");
      check.className = "receipt-check";
      check.innerHTML = "&#10003;";
      row.appendChild(check);
    }

    container.appendChild(row);
  }

  // Update status text
  if (msg.status === "succeeded") {
    document.getElementById("callStatusText").textContent = "Payment succeeded";
  } else if (msg.status === "failed") {
    document.getElementById("callStatusText").textContent = "Payment failed";
  }

  // Add timeline node
  const type = "pay";
  const text = `${msg.status === "processing" ? "Processing" : msg.status === "succeeded" ? "Paid" : "Failed"}: ${sym}${(msg.amount / 100).toFixed(2)} ${msg.description}`;
  const node = { type, text: text.length > 100 ? text.slice(0, 97) + "..." : text, timestamp: Date.now() };
  timelineNodes.push(node);
  if (expandedViewOpen) renderTimelineNode(node);
}

// ── Call Action Bar ─────────────────────────

let micMuted = false;
let micStream = null;

document.getElementById("muteBtnAction").addEventListener("click", () => {
  micMuted = !micMuted;
  const btn = document.getElementById("muteBtnAction");
  if (micMuted) {
    btn.classList.add("muted");
    btn.title = "Unmute microphone";
    if (micStream) micStream.getAudioTracks().forEach(t => t.enabled = false);
  } else {
    btn.classList.remove("muted");
    btn.title = "Mute microphone";
    if (micStream) micStream.getAudioTracks().forEach(t => t.enabled = true);
  }
});

document.getElementById("speakerBtnAction").addEventListener("click", () => {
  audioRelayEnabled = !audioRelayEnabled;
  const btn = document.getElementById("speakerBtnAction");
  if (audioRelayEnabled) {
    btn.classList.add("active");
    btn.title = "Peer audio playing";
  } else {
    btn.classList.remove("active");
    btn.title = "Hear peer audio";
  }
});

document.getElementById("detailsBtnAction").addEventListener("click", openExpandedView);

document.getElementById("endCallBtn").addEventListener("click", () => {
  if (confirm("Leave the call?")) {
    location.reload();
  }
});

// ── Bottom Sheet Dismiss ─────────────────────

document.getElementById("sheetHandle").addEventListener("click", () => {
  document.getElementById("bottomSheet").classList.remove("visible");
});

// ── Document Overlay Close ───────────────────

document.getElementById("closeDocBtn").addEventListener("click", () => {
  document.getElementById("documentOverlay").style.display = "none";
});

// Dismiss document overlay on backdrop click (clicking outside the modal)
document.getElementById("documentOverlay").addEventListener("click", (e) => {
  if (e.target === document.getElementById("documentOverlay")) {
    document.getElementById("documentOverlay").style.display = "none";
  }
});

// ── Settings Drawer ──────────────────────────

function openDrawer() {
  document.getElementById("drawerOverlay").classList.add("open");
  document.getElementById("settingsDrawer").classList.add("open");
}

function closeDrawer() {
  document.getElementById("drawerOverlay").classList.remove("open");
  document.getElementById("settingsDrawer").classList.remove("open");
}

document.getElementById("gearBtn").addEventListener("click", openDrawer);
document.getElementById("closeDrawerBtn").addEventListener("click", closeDrawer);
document.getElementById("drawerOverlay").addEventListener("click", closeDrawer);

document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") {
    // Close verification overlay first (highest z-index)
    const verifyOverlay = document.getElementById("verificationOverlay");
    if (verifyOverlay && verifyOverlay.style.display === "flex") {
      verifyOverlay.style.display = "none";
      activeVerification = null;
      return;
    }
    // Close document overlay
    const docOverlay = document.getElementById("documentOverlay");
    if (docOverlay && docOverlay.style.display === "flex") {
      docOverlay.style.display = "none";
      return;
    }
    // Close settings drawer
    if (document.getElementById("settingsDrawer").classList.contains("open")) {
      closeDrawer();
      return;
    }
    // Dismiss bottom sheet
    const bottomSheet = document.getElementById("bottomSheet");
    if (bottomSheet && bottomSheet.classList.contains("visible")) {
      bottomSheet.classList.remove("visible");
    }
  }
});

// Copy room code to clipboard
document.getElementById("copyRoomBtn").addEventListener("click", () => {
  const code = document.getElementById("roomCode").value;
  if (!code) return;
  navigator.clipboard.writeText(code).then(() => {
    const btn = document.getElementById("copyRoomBtn");
    btn.innerHTML = "&#10003;";
    btn.style.color = "#2d9c3c";
    setTimeout(() => { btn.innerHTML = "&#128203;"; btn.style.color = ""; }, 1500);
  });
});

// Sync currency symbol when dropdown changes
const CURRENCY_SYMBOLS = { gbp: "\u00A3", usd: "$", eur: "\u20AC" };
document.getElementById("currency").addEventListener("change", (e) => {
  const sym = CURRENCY_SYMBOLS[e.target.value] || "\u00A3";
  document.getElementById("currencySymbol").textContent = sym;
  document.getElementById("escrowSymbol").textContent = sym;
});

// ── Form Submit ──────────────────────────────

document.getElementById("profileForm").addEventListener("submit", (e) => {
  e.preventDefault();
  const profile = buildProfile();
  if (!profile.displayName) {
    document.getElementById("setupStatus").textContent = "Name is required";
    return;
  }
  const roomCode = document.getElementById("roomCode").value.trim();
  if (!roomCode) {
    document.getElementById("setupStatus").textContent = "Room code is required";
    return;
  }
  const userId = generateUserId(profile.displayName);
  myUserId = userId;
  myDisplayName = profile.displayName;
  document.getElementById("colHeaderA").textContent = profile.displayName;
  startSession(userId, roomCode, profile);
});

// ── Session Start ────────────────────────────

function startSession(userId, roomCode, profile) {
  document.getElementById("setup").style.display = "none";
  document.getElementById("session").style.display = "flex";
  document.getElementById("myNameLabel").textContent = profile.displayName;

  const wsProtocol = location.protocol === "https:" ? "wss:" : "ws:";
  const baseUrl = `${wsProtocol}//${location.host}`;

  let audioWs = null;
  let panelReconnectAttempts = 0;
  let audioReconnectAttempts = 0;
  const MAX_RECONNECT = 10;

  function connectPanel() {
    const panelWs = new WebSocket(
      `${baseUrl}/ws/panels?room=${encodeURIComponent(roomCode)}&user=${encodeURIComponent(userId)}`
    );
    panelWsRef = panelWs;

    panelWs.addEventListener("open", () => {
      panelReconnectAttempts = 0;
      const dot = document.getElementById("statusDot");
      if (dot.classList.contains("reconnecting")) {
        dot.className = "status-dot connected";
      }
      panelWs.send(JSON.stringify({ type: "set_profile", profile }));
      panelWs.send(JSON.stringify({ type: "join_room", roomId: roomCode }));
    });

    panelWs.addEventListener("close", () => {
      if (panelReconnectAttempts < MAX_RECONNECT) {
        const dot = document.getElementById("statusDot");
        dot.className = "status-dot waiting";
        const delay = Math.min(1000 * Math.pow(2, panelReconnectAttempts), 10000);
        panelReconnectAttempts++;
        setTimeout(connectPanel, delay);
      } else {
        document.getElementById("statusDot").className = "status-dot error";
        document.getElementById("callStatusText").textContent = "Connection lost";
      }
    });

    setupPanelHandler(panelWs, userId, connectAudio);
  }

  function connectAudio() {
    if (audioWs && audioWs.readyState <= WebSocket.OPEN) return;
    audioWs = new WebSocket(
      `${baseUrl}/ws/audio?room=${encodeURIComponent(roomCode)}&user=${encodeURIComponent(userId)}`
    );
    audioWs.binaryType = "arraybuffer";
    audioWs.addEventListener("open", () => {
      audioReconnectAttempts = 0;
      startMicrophone(audioWs);
    });
    audioWs.addEventListener("close", () => {
      if (audioReconnectAttempts < MAX_RECONNECT) {
        const delay = Math.min(1000 * Math.pow(2, audioReconnectAttempts), 10000);
        audioReconnectAttempts++;
        setTimeout(connectAudio, delay);
      }
    });
    setupAudioPlayback(audioWs);
  }

  connectPanel();
}

// ── Microphone Capture ───────────────────────

const TARGET_SAMPLE_RATE = 16000;

function resampleTo16kHz(float32, sourceSampleRate) {
  if (sourceSampleRate === TARGET_SAMPLE_RATE) return float32;
  const ratio = sourceSampleRate / TARGET_SAMPLE_RATE;
  const outputLength = Math.floor(float32.length / ratio);
  const output = new Float32Array(outputLength);
  for (let i = 0; i < outputLength; i++) {
    const srcIndex = i * ratio;
    const low = Math.floor(srcIndex);
    const high = Math.min(low + 1, float32.length - 1);
    const frac = srcIndex - low;
    output[i] = float32[low] * (1 - frac) + float32[high] * frac;
  }
  return output;
}

function floatTo16BitPCM(float32) {
  const int16 = new Int16Array(float32.length);
  for (let i = 0; i < float32.length; i++) {
    const s = Math.max(-1, Math.min(1, float32[i]));
    int16[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
  }
  return int16;
}

async function startMicrophone(audioWs) {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      audio: { channelCount: 1, echoCancellation: true, noiseSuppression: true },
    });
    micStream = stream;

    // Let the browser pick its native sample rate — we resample to 16kHz ourselves
    const audioContext = new AudioContext();
    const actualRate = audioContext.sampleRate;
    console.log(`[mic] AudioContext sample rate: ${actualRate}`);

    // Resume context on mobile (iOS requires user gesture)
    if (audioContext.state === "suspended") {
      await audioContext.resume();
    }

    const source = audioContext.createMediaStreamSource(stream);

    // Try AudioWorklet first, fall back to ScriptProcessor
    if (typeof AudioWorkletNode !== "undefined" && audioContext.audioWorklet) {
      try {
        const workletCode = `
          class PCMProcessor extends AudioWorkletProcessor {
            process(inputs) {
              const input = inputs[0];
              if (input.length > 0 && input[0].length > 0) {
                this.port.postMessage(input[0]);
              }
              return true;
            }
          }
          registerProcessor("pcm-processor", PCMProcessor);
        `;
        const blob = new Blob([workletCode], { type: "application/javascript" });
        const workletUrl = URL.createObjectURL(blob);
        await audioContext.audioWorklet.addModule(workletUrl);
        URL.revokeObjectURL(workletUrl);

        const workletNode = new AudioWorkletNode(audioContext, "pcm-processor");
        workletNode.port.onmessage = (event) => {
          if (audioWs.readyState !== WebSocket.OPEN) return;
          const resampled = resampleTo16kHz(event.data, actualRate);
          audioWs.send(floatTo16BitPCM(resampled).buffer);
        };
        source.connect(workletNode);
        workletNode.connect(audioContext.destination);
        console.log("[mic] Using AudioWorklet");
        return;
      } catch (workletErr) {
        console.warn("[mic] AudioWorklet failed, falling back to ScriptProcessor:", workletErr);
      }
    }

    // Fallback: ScriptProcessor (deprecated but widely supported)
    const processor = audioContext.createScriptProcessor(4096, 1, 1);
    processor.onaudioprocess = (event) => {
      if (audioWs.readyState !== WebSocket.OPEN) return;
      const float32 = event.inputBuffer.getChannelData(0);
      const resampled = resampleTo16kHz(float32, actualRate);
      audioWs.send(floatTo16BitPCM(resampled).buffer);
    };
    source.connect(processor);
    processor.connect(audioContext.destination);
    console.log("[mic] Using ScriptProcessor (fallback)");
  } catch (err) {
    console.error("Microphone error:", err);
    document.getElementById("callStatusText").textContent = "Microphone access denied";
    document.getElementById("statusDot").className = "status-dot error";
  }
}

// ── Audio Playback ───────────────────────────

function setupAudioPlayback(audioWs) {
  let playbackContext = null;
  let nextPlayTime = 0;

  audioWs.addEventListener("message", (event) => {
    if (typeof event.data === "string") return;
    if (!audioRelayEnabled) return;

    if (!playbackContext) {
      playbackContext = new AudioContext({ sampleRate: 16000 });
      nextPlayTime = playbackContext.currentTime;
    }

    const int16 = new Int16Array(event.data);
    const float32 = new Float32Array(int16.length);
    for (let i = 0; i < int16.length; i++) {
      float32[i] = int16[i] / (int16[i] < 0 ? 0x8000 : 0x7FFF);
    }

    const buffer = playbackContext.createBuffer(1, float32.length, 16000);
    buffer.getChannelData(0).set(float32);

    const source = playbackContext.createBufferSource();
    source.buffer = buffer;
    source.connect(playbackContext.destination);

    const now = playbackContext.currentTime;
    if (nextPlayTime < now) nextPlayTime = now;
    source.start(nextPlayTime);
    nextPlayTime += buffer.duration;
  });
}

// ── Panel Message Handler ────────────────────

function setupPanelHandler(panelWs, userId, onRoomJoined) {
  panelWs.addEventListener("message", (event) => {
    try {
      const msg = JSON.parse(event.data);
      switch (msg.panel) {
        case "transcript": handleTranscript(msg, userId); break;
        case "agent": handleAgent(msg); break;
        case "negotiation": handleNegotiation(msg); break;
        case "document": handleDocument(msg, panelWs); break;
        case "milestone": handleMilestone(msg); break;
        case "execution": handleExecution(msg); break;
        case "payment_receipt": handlePaymentReceipt(msg); break;
        case "status":
          handleStatus(msg);
          if (onRoomJoined) { onRoomJoined(); onRoomJoined = null; }
          break;
        case "verification": handleVerification(msg); break;
        case "error": handleError(msg); break;
      }
    } catch { /* ignore malformed messages */ }
  });
}

// ── Contract Persistence ─────────────────────

const CONTRACTS_KEY = "handshake_contracts";
const MAX_CONTRACTS = 10;
const MAX_CONTRACT_SIZE = 51200; // 50KB

function saveContract(doc) {
  try {
    const contracts = JSON.parse(localStorage.getItem(CONTRACTS_KEY) || "[]");
    // Attach transcript context (last 50 final entries) when saving for the first time
    const idx = contracts.findIndex(c => c.id === doc.id);
    const docWithHistory = { ...doc };
    if (idx < 0 && transcriptBuffer.length > 0) {
      docWithHistory.conversationHistory = transcriptBuffer
        .filter(e => !e.isPartial)
        .slice(-50)
        .map(e => ({ speaker: e.speaker, text: e.text, timestamp: e.timestamp, isLocal: e.isLocal }));
    } else if (idx >= 0 && contracts[idx].conversationHistory) {
      // Preserve existing history on updates
      docWithHistory.conversationHistory = contracts[idx].conversationHistory;
    }
    const serialized = JSON.stringify(docWithHistory);
    if (serialized.length > MAX_CONTRACT_SIZE) return;
    if (idx >= 0) {
      contracts[idx] = docWithHistory;
    } else {
      contracts.unshift(docWithHistory);
    }
    while (contracts.length > MAX_CONTRACTS) contracts.pop();
    localStorage.setItem(CONTRACTS_KEY, JSON.stringify(contracts));
  } catch { /* localStorage full or unavailable */ }
}

function loadContracts() {
  try {
    return JSON.parse(localStorage.getItem(CONTRACTS_KEY) || "[]");
  } catch { return []; }
}

// ── Factor Rendering ─────────────────────────

function renderFactorSummary(doc) {
  const el = document.getElementById("sheetFactors");
  el.innerHTML = "";
  if (!doc.terms) return;

  const rangeItems = (doc.terms.lineItems || []).filter(li => li.minAmount != null && li.maxAmount != null);
  if (rangeItems.length === 0 && !doc.terms.factorSummary) return;

  // Render range items with factors
  for (const li of rangeItems) {
    const div = document.createElement("div");
    div.className = "range-item";
    div.innerHTML = `<span class="range-amount">\u00A3${(li.minAmount / 100).toFixed(2)}\u2013\u00A3${(li.maxAmount / 100).toFixed(2)}</span> ${escapeHtml(li.description)}`;
    if (li.factors && li.factors.length > 0) {
      const factorLine = document.createElement("div");
      factorLine.style.marginTop = "4px";
      for (const f of li.factors) {
        const tag = document.createElement("span");
        tag.className = "factor-tag";
        tag.textContent = `${f.name} (${f.impact})`;
        tag.title = f.description;
        factorLine.appendChild(tag);
      }
      div.appendChild(factorLine);
    }
    el.appendChild(div);
  }

  // Factor summary text
  if (doc.terms.factorSummary) {
    const p = document.createElement("p");
    p.style.cssText = "font-size:12px;color:#888;margin-top:6px;line-height:1.4;";
    p.textContent = doc.terms.factorSummary;
    el.appendChild(p);
  }
}

// ── My Contracts ─────────────────────────────

document.getElementById("myContractsBtn").addEventListener("click", () => {
  showContractsPage();
});

function showContractsPage() {
  document.getElementById("setup").style.display = "none";
  document.getElementById("session").style.display = "none";
  document.getElementById("contracts").style.display = "flex";
  renderContractsPage();
}

document.getElementById("contractsBackBtn").addEventListener("click", () => {
  document.getElementById("contracts").style.display = "none";
  document.getElementById("setup").style.display = "flex";
});

function renderContractsPage() {
  const list = document.getElementById("contractsList");
  const contracts = loadContracts();

  if (contracts.length === 0) {
    list.innerHTML = '<div class="contracts-empty">No contracts yet. Join a room and negotiate to create one.</div>';
    return;
  }

  list.innerHTML = "";
  for (const doc of contracts) {
    list.appendChild(renderContractCard(doc));
  }
}

function renderContractCard(doc) {
  const card = document.createElement("div");
  card.className = "contract-card";

  // Header
  const header = document.createElement("div");
  header.className = "contract-card-header";
  const title = document.createElement("div");
  title.className = "contract-card-title";
  title.textContent = doc.title || "Untitled Agreement";
  const date = document.createElement("div");
  date.className = "contract-card-date";
  date.textContent = new Date(doc.createdAt).toLocaleDateString();
  header.appendChild(title);
  header.appendChild(date);
  card.appendChild(header);

  // Parties
  if (doc.parties && doc.parties.length > 0) {
    const parties = document.createElement("div");
    parties.className = "contract-card-parties";
    parties.textContent = doc.parties.map(p => p.name).join(" & ");
    card.appendChild(parties);
  }

  // Amount
  if (doc.terms && doc.terms.totalAmount) {
    const amount = document.createElement("div");
    amount.className = "contract-card-amount";
    const sym = CURRENCY_SYMBOLS[doc.terms.currency] || "\u00A3";
    amount.textContent = `${sym}${(doc.terms.totalAmount / 100).toFixed(2)}`;
    card.appendChild(amount);
  }

  // Milestones
  if (doc.milestones && doc.milestones.length > 0) {
    const msContainer = document.createElement("div");
    msContainer.className = "contract-milestones";

    for (const ms of doc.milestones) {
      const row = document.createElement("div");
      row.className = "contract-milestone-row";

      const dot = document.createElement("div");
      dot.className = `ms-status-dot ${ms.status}`;

      const desc = document.createElement("div");
      desc.className = "contract-ms-desc";
      desc.textContent = ms.description;

      const msAmount = document.createElement("div");
      msAmount.className = "contract-ms-amount";
      msAmount.textContent = "\u00A3" + (ms.amount / 100).toFixed(2);

      row.appendChild(dot);
      row.appendChild(desc);
      row.appendChild(msAmount);

      if (ms.status === "pending") {
        const verifyBtn = document.createElement("button");
        verifyBtn.className = "verify-btn";
        verifyBtn.textContent = "Verify";
        verifyBtn.onclick = (e) => {
          e.stopPropagation();
          openVerificationModal(doc, ms);
        };
        row.appendChild(verifyBtn);
      } else if (ms.status !== "pending") {
        const badge = document.createElement("span");
        badge.className = `ms-status-badge ${ms.status}`;
        const labels = { completed: "Done", failed: "Failed", disputed: "Disputed", verifying: "Verifying..." };
        badge.textContent = labels[ms.status] || ms.status;
        row.appendChild(badge);
      }

      msContainer.appendChild(row);
    }

    card.appendChild(msContainer);
  }

  // Conversation history snippet
  if (doc.conversationHistory && doc.conversationHistory.length > 0) {
    const convSection = document.createElement("div");
    convSection.style.cssText = "margin-top:10px;border-top:1px solid #222;padding-top:8px;";
    const convHeader = document.createElement("div");
    convHeader.style.cssText = "font-size:11px;color:#555;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;cursor:pointer;";
    convHeader.textContent = `Conversation (${doc.conversationHistory.length} entries) \u25B6`;
    const convBody = document.createElement("div");
    convBody.style.cssText = "display:none;max-height:200px;overflow-y:auto;";
    convHeader.onclick = () => {
      const visible = convBody.style.display !== "none";
      convBody.style.display = visible ? "none" : "block";
      convHeader.textContent = `Conversation (${doc.conversationHistory.length} entries) ${visible ? "\u25B6" : "\u25BC"}`;
    };
    for (const entry of doc.conversationHistory.slice(-20)) {
      const line = document.createElement("div");
      line.style.cssText = "font-size:12px;color:#888;padding:3px 0;border-bottom:1px solid #1a1a1a;";
      const speaker = entry.isLocal ? "You" : "Peer";
      line.textContent = `${speaker}: ${entry.text}`;
      convBody.appendChild(line);
    }
    convSection.appendChild(convHeader);
    convSection.appendChild(convBody);
    card.appendChild(convSection);
  }

  // View full document button
  const viewBtn = document.createElement("button");
  viewBtn.className = "contract-view-btn";
  viewBtn.textContent = "View Full Document";
  viewBtn.onclick = () => {
    document.getElementById("documentTitle").textContent = doc.title;
    document.getElementById("documentContent").innerHTML = markdownToHtml(doc.content);
    updateSignatureStatus(doc);
    const signBtn = document.getElementById("signBtn");
    signBtn.disabled = true;
    signBtn.textContent = doc.status === "fully_signed" ? "Signed \u2713" : "View Only";

    // Populate milestones in overlay from saved contract
    const section = document.getElementById("milestonesSection");
    const msList = document.getElementById("milestonesList");
    if (doc.milestones && doc.milestones.length > 0) {
      section.style.display = "block";
      msList.innerHTML = "";
      for (const ms of doc.milestones) {
        milestoneMap.set(ms.id, ms);
        const item = document.createElement("div");
        item.className = "milestone-item";
        const dot = document.createElement("div");
        dot.className = "milestone-dot" + (ms.status === "completed" ? " completed" : "");
        const info = document.createElement("div");
        info.className = "milestone-info";
        const desc = document.createElement("div");
        desc.className = "milestone-desc";
        desc.textContent = ms.description;
        const cond = document.createElement("div");
        cond.className = "milestone-condition";
        cond.textContent = ms.condition;
        info.appendChild(desc);
        info.appendChild(cond);
        const amount = document.createElement("div");
        amount.className = "milestone-amount" + (ms.status === "completed" ? " completed" : "");
        amount.textContent = "\u00A3" + (ms.amount / 100).toFixed(2);
        item.appendChild(dot);
        item.appendChild(info);
        item.appendChild(amount);

        if (ms.status === "pending") {
          const vBtn = document.createElement("button");
          vBtn.className = "milestone-complete-btn";
          vBtn.textContent = "Verify";
          vBtn.onclick = (ev) => { ev.stopPropagation(); openVerificationModal(doc, ms); };
          item.appendChild(vBtn);
        } else {
          const badge = document.createElement("div");
          const colors = { completed: "#2d9c3c", failed: "#e74c3c", disputed: "#8e44ad", verifying: "#3498db" };
          const labels = { completed: "\u2713 Done", failed: "\u2717 Failed", disputed: "Disputed", verifying: "Verifying..." };
          badge.style.cssText = `font-size:12px;color:${colors[ms.status] || "#888"};white-space:nowrap;`;
          badge.textContent = labels[ms.status] || ms.status;
          item.appendChild(badge);
        }
        msList.appendChild(item);
      }
    } else {
      section.style.display = "none";
    }

    document.getElementById("documentOverlay").style.display = "flex";
  };
  card.appendChild(viewBtn);

  return card;
}

// ── Verification Modal ──────────────────────

let activeVerification = null;

function openVerificationModal(doc, milestone) {
  activeVerification = { documentId: doc.id, milestoneId: milestone.id };

  document.getElementById("verifyMsTitle").textContent = milestone.description;
  document.getElementById("verifyMsCondition").textContent = `Condition: ${milestone.condition}`;
  document.getElementById("verifyPhone").value = "";
  document.getElementById("verifyContactName").value = "";
  document.getElementById("verifyInputGroup").style.display = "flex";
  document.getElementById("startVerifyBtn").style.display = "block";
  document.getElementById("startVerifyBtn").disabled = false;
  document.getElementById("startVerifyBtn").textContent = "Start Verification";
  document.getElementById("verifyProgress").style.display = "none";
  document.getElementById("verifyProgress").innerHTML = "";
  document.getElementById("verifyResult").style.display = "none";
  document.getElementById("verifyResult").className = "verify-result";
  document.getElementById("verificationOverlay").style.display = "flex";
}

document.getElementById("closeVerifyBtn").addEventListener("click", () => {
  document.getElementById("verificationOverlay").style.display = "none";
  activeVerification = null;
});

document.getElementById("startVerifyBtn").addEventListener("click", () => {
  if (!activeVerification) return;
  if (!panelWsRef || panelWsRef.readyState !== WebSocket.OPEN) {
    const progress = document.getElementById("verifyProgress");
    progress.style.display = "flex";
    progress.innerHTML = '<div style="color:#e74c3c;font-size:13px;padding:8px 0;">You must be in an active room to verify milestones. Join the room first, then verify from the session.</div>';
    document.getElementById("startVerifyBtn").disabled = true;
    return;
  }

  const phone = document.getElementById("verifyPhone").value.trim() || undefined;
  const contactName = document.getElementById("verifyContactName").value.trim() || undefined;

  const msg = {
    type: "verify_milestone",
    documentId: activeVerification.documentId,
    milestoneId: activeVerification.milestoneId,
  };
  if (phone) msg.phoneNumber = phone;
  if (contactName) msg.contactName = contactName;

  panelWsRef.send(JSON.stringify(msg));

  document.getElementById("startVerifyBtn").disabled = true;
  document.getElementById("startVerifyBtn").textContent = "Verifying...";
  document.getElementById("verifyInputGroup").style.display = "none";
  document.getElementById("verifyProgress").style.display = "flex";
  addVerifyStep("started", "Starting verification...");
});

function addVerifyStep(stepId, text) {
  const progress = document.getElementById("verifyProgress");

  // Mark previous active steps as done
  const activeDots = progress.querySelectorAll(".verify-step-dot.active");
  for (const d of activeDots) d.className = "verify-step-dot done";

  const step = document.createElement("div");
  step.className = "verify-step";
  step.dataset.step = stepId;

  const dot = document.createElement("div");
  dot.className = "verify-step-dot active";

  const label = document.createElement("div");
  label.className = "verify-step-text";
  label.textContent = text;

  step.appendChild(dot);
  step.appendChild(label);
  progress.appendChild(step);
  progress.scrollTop = progress.scrollHeight;
}

function showVerifyResult(result) {
  const el = document.getElementById("verifyResult");
  el.style.display = "block";
  el.className = `verify-result ${result.status}`;

  const statusLabels = { passed: "PASSED", failed: "FAILED", disputed: "DISPUTED" };
  document.getElementById("verifyResultStatus").textContent = statusLabels[result.status] || result.status;
  document.getElementById("verifyResultReasoning").textContent = result.reasoning;

  // Amount
  const amountEl = document.getElementById("verifyResultAmount");
  if (result.capturedAmount != null) {
    amountEl.textContent = `Captured: \u00A3${(result.capturedAmount / 100).toFixed(2)}`;
    amountEl.style.display = "block";
  } else if (result.recommendedAmount != null && result.status === "passed") {
    amountEl.textContent = `Amount: \u00A3${(result.recommendedAmount / 100).toFixed(2)}`;
    amountEl.style.display = "block";
  } else {
    amountEl.style.display = "none";
  }

  // Evidence
  const evidenceList = document.getElementById("verifyEvidenceList");
  evidenceList.innerHTML = "";
  if (result.evidence && result.evidence.length > 0) {
    for (const ev of result.evidence) {
      const item = document.createElement("div");
      item.className = "verify-evidence-item";
      const header = document.createElement("div");
      header.style.cssText = "font-weight:600;color:#aaa;margin-bottom:2px;";
      header.textContent = `[${ev.type}] ${ev.description}: ${ev.result}`;
      item.appendChild(header);
      if (ev.details) {
        const details = document.createElement("div");
        details.style.cssText = "color:#777;white-space:pre-wrap;word-break:break-word;font-size:11px;line-height:1.4;max-height:120px;overflow-y:auto;";
        details.textContent = ev.details;
        item.appendChild(details);
      }
      evidenceList.appendChild(item);
    }
  }

  // Mark progress dots as done
  const activeDots = document.getElementById("verifyProgress").querySelectorAll(".verify-step-dot.active");
  for (const d of activeDots) d.className = "verify-step-dot done";

  document.getElementById("startVerifyBtn").style.display = "none";

  // Refresh contracts page
  renderContractsPage();
}

function handleVerification(msg) {
  if (!activeVerification || msg.milestoneId !== activeVerification.milestoneId) return;

  if (msg.step === "completed" && msg.result) {
    showVerifyResult(msg.result);
    // Update the stored contract
    const contracts = loadContracts();
    const contractIdx = contracts.findIndex(c => c.id === activeVerification.documentId);
    if (contractIdx >= 0 && contracts[contractIdx].milestones) {
      contracts[contractIdx].milestones = contracts[contractIdx].milestones.map(m =>
        m.id === msg.milestoneId
          ? { ...m, status: msg.result.status === "passed" ? "completed" : msg.result.status, verificationResult: msg.result }
          : m
      );
      localStorage.setItem(CONTRACTS_KEY, JSON.stringify(contracts));
    }
  } else if (msg.status === "in_progress") {
    const stepLabels = {
      started: "Starting verification...",
      phone_call: msg.details || "Making phone call...",
      factor_assessment: msg.details || "Assessing conditions...",
      self_attestation: msg.details || "Recording attestation...",
      payment_history: msg.details || "Checking payment history...",
    };
    addVerifyStep(msg.step, stepLabels[msg.step] || msg.details || msg.step);
  }
}

// ── Init ─────────────────────────────────────

loadProfile();
document.getElementById("roomCode").value = generateRoomCode();
</script>
</body>
</html>
