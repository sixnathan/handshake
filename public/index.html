<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Handshake</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: "SF Mono", "Fira Code", "Cascadia Code", monospace;
  background: #0a0a0a;
  color: #e0e0e0;
  height: 100vh;
  overflow: hidden;
}

/* Setup screen */
#setup {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  padding: 24px;
  position: relative;
}
#setup h1 { color: #2d9c3c; margin-bottom: 4px; font-size: 32px; }
#setup .tagline { color: #666; font-size: 13px; margin-bottom: 28px; }
#setup form {
  display: flex; flex-direction: column; gap: 10px;
  width: 100%; max-width: 340px;
}
#setup input {
  background: #1a1a1a; border: 1px solid #333; color: #e0e0e0;
  padding: 12px 14px; font-size: 15px; font-family: inherit; border-radius: 6px;
}
#setup input:focus { border-color: #2d9c3c; outline: none; }
.room-row { display: flex; gap: 8px; }
.room-row input { flex: 1; }
#copyRoomBtn {
  background: #1a1a1a; border: 1px solid #333; color: #888;
  width: 42px; border-radius: 6px; cursor: pointer; font-size: 16px;
  display: flex; align-items: center; justify-content: center;
  transition: color 0.2s;
}
#copyRoomBtn:hover { color: #e0e0e0; border-color: #555; }
#setup button[type="submit"] {
  background: #2d9c3c; color: white; border: none; padding: 14px;
  font-size: 16px; font-family: inherit; border-radius: 6px; cursor: pointer; margin-top: 4px;
}
#setup button[type="submit"]:hover { background: #238b31; }
#setupStatus { color: #e74c3c; font-size: 14px; margin-top: 8px; }
#gearBtn {
  position: absolute; top: 20px; right: 20px;
  background: none; border: 1px solid #333; color: #888;
  width: 38px; height: 38px; border-radius: 6px; cursor: pointer;
  font-size: 18px; display: flex; align-items: center; justify-content: center;
  transition: color 0.2s, border-color 0.2s;
}
#gearBtn:hover { color: #e0e0e0; border-color: #555; }

/* Settings drawer */
#drawerOverlay {
  display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.5); z-index: 200;
}
#drawerOverlay.open { display: block; }
#settingsDrawer {
  position: fixed; top: 0; right: 0; bottom: 0;
  width: 380px; max-width: 90vw; z-index: 201;
  background: #111; border-left: 1px solid #222;
  transform: translateX(100%); transition: transform 0.3s ease;
  display: flex; flex-direction: column;
}
#settingsDrawer.open { transform: translateX(0); }
.drawer-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 16px 20px; border-bottom: 1px solid #222;
}
.drawer-header h2 { font-size: 16px; color: #e0e0e0; }
#closeDrawerBtn {
  background: none; border: none; color: #888; font-size: 22px; cursor: pointer;
  padding: 0 4px; line-height: 1;
}
#closeDrawerBtn:hover { color: #e0e0e0; }
.drawer-body {
  flex: 1; overflow-y: auto; padding: 16px 20px;
  display: flex; flex-direction: column; gap: 6px;
}
.drawer-body h3 {
  color: #888; font-size: 12px; text-transform: uppercase;
  letter-spacing: 1px; margin: 12px 0 4px; padding-top: 8px; border-top: 1px solid #1a1a1a;
}
.drawer-body h3:first-child { margin-top: 0; border-top: none; padding-top: 0; }
.drawer-body input, .drawer-body select, .drawer-body textarea {
  background: #1a1a1a; border: 1px solid #333; color: #e0e0e0;
  padding: 10px 12px; font-size: 14px; font-family: inherit; border-radius: 6px;
  width: 100%;
}
.drawer-body input:focus, .drawer-body select:focus, .drawer-body textarea:focus {
  border-color: #2d9c3c; outline: none;
}
.drawer-body textarea { min-height: 60px; resize: vertical; }
.drawer-body label {
  display: flex; align-items: center; gap: 8px; font-size: 13px; color: #aaa;
}
.drawer-body label input, .drawer-body label select { flex: 1; }
.currency-prefix {
  display: flex; align-items: center; gap: 0; font-size: 13px; color: #aaa;
}
.currency-prefix span {
  background: #1a1a1a; border: 1px solid #333; border-right: none;
  padding: 10px 8px 10px 12px; border-radius: 6px 0 0 6px; color: #888;
  font-size: 14px; min-width: 24px; text-align: center;
}
.currency-prefix input {
  border-radius: 0 6px 6px 0 !important; flex: 1;
}

/* Session screen */
#session { display: none; height: 100vh; flex-direction: column; }

/* ── Top Bar ────────────────────────────────── */
.top-bar {
  display: flex;
  align-items: center;
  padding: 12px 20px;
  background: #111;
  border-bottom: 1px solid #222;
  z-index: 10;
}
.top-bar-left {
  display: flex;
  align-items: center;
  gap: 10px;
  flex: 1;
}
.status-dot {
  width: 10px; height: 10px; border-radius: 50%; background: #f5a623;
  flex-shrink: 0;
}
.status-dot.connected { background: #2d9c3c; }
.status-dot.error { background: #e74c3c; }
@keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
.status-dot.waiting { animation: pulse-dot 1.5s infinite; }
#peerName {
  font-size: 16px;
  font-weight: bold;
  color: #e0e0e0;
}
.top-bar-center {
  flex: 1;
  text-align: center;
}
#callTimer {
  font-size: 20px;
  font-variant-numeric: tabular-nums;
  color: #888;
  letter-spacing: 1px;
}
.top-bar-right {
  flex: 1;
  display: flex;
  justify-content: flex-end;
}
#expandBtn {
  background: #1a1a1a;
  border: 1px solid #333;
  color: #aaa;
  padding: 6px 14px;
  font-size: 13px;
  font-family: inherit;
  border-radius: 4px;
  cursor: pointer;
  transition: background 0.15s, color 0.15s;
}
#expandBtn:hover { background: #222; color: #e0e0e0; }
#audioToggleBtn {
  background: #1a1a1a;
  border: 1px solid #333;
  color: #888;
  width: 36px; height: 36px;
  font-size: 18px;
  border-radius: 4px;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  margin-right: 8px;
  transition: color 0.15s, border-color 0.15s;
  position: relative;
}
#audioToggleBtn:hover { color: #e0e0e0; border-color: #555; }
#audioToggleBtn.unmuted { color: #2d9c3c; border-color: #2d9c3c; }

/* ── Call Center (default view) ──────────────── */
.call-center {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 24px;
}
.pulse-ring {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  border: 2px solid #2d9c3c;
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
}
.pulse-ring::before,
.pulse-ring::after {
  content: "";
  position: absolute;
  width: 100%;
  height: 100%;
  border-radius: 50%;
  border: 1px solid #2d9c3c;
  animation: pulse-ring-anim 2.5s ease-out infinite;
}
.pulse-ring::after {
  animation-delay: 1.25s;
}
@keyframes pulse-ring-anim {
  0% { transform: scale(1); opacity: 0.6; }
  100% { transform: scale(1.8); opacity: 0; }
}
.pulse-ring-inner {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  background: #2d9c3c;
}
#callStatusText {
  font-size: 16px;
  color: #666;
  letter-spacing: 1px;
}

/* ── Expanded View ──────────────────────────── */
.expanded-view {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: #0a0a0a;
  z-index: 50;
  flex-direction: column;
}
.expanded-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 20px;
  background: #111;
  border-bottom: 1px solid #222;
}
.expanded-header h2 {
  font-size: 16px;
  color: #e0e0e0;
  font-weight: 600;
}
#collapseBtn {
  background: none;
  border: none;
  color: #888;
  font-size: 22px;
  cursor: pointer;
  padding: 4px 8px;
  line-height: 1;
}
#collapseBtn:hover { color: #e0e0e0; }
.expanded-body {
  flex: 1;
  display: flex;
  overflow: hidden;
}

/* ── Dual-Column Transcript ─────────────────── */
.transcript-dual {
  flex: 1;
  display: flex;
  border-right: 1px solid #222;
  overflow: hidden;
}
.transcript-col {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}
.transcript-col-header {
  padding: 8px 12px;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: #555;
  background: #111;
  border-bottom: 1px solid #222;
  flex-shrink: 0;
}
.transcript-col-content {
  flex: 1;
  overflow-y: auto;
  padding: 8px 12px;
}
.transcript-divider {
  width: 1px;
  background: #222;
  flex-shrink: 0;
}

/* Transcript bubbles */
.t-bubble {
  margin-bottom: 8px;
  padding: 8px 10px;
  border-radius: 6px;
  background: #141414;
  border-left: 3px solid #2d9c3c;
  font-size: 13px;
  line-height: 1.5;
}
.t-bubble-peer {
  border-left-color: #3498db;
}
.t-bubble-partial {
  color: #555;
  font-style: italic;
  border-left-color: #333;
  background: #0f0f0f;
}
.t-bubble-time {
  display: block;
  font-size: 10px;
  color: #444;
  margin-top: 4px;
  font-variant-numeric: tabular-nums;
}

/* ── Workflow Timeline ──────────────────────── */
.workflow-timeline {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}
.workflow-timeline-header {
  padding: 8px 12px;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: #555;
  background: #111;
  border-bottom: 1px solid #222;
  flex-shrink: 0;
}
#timelineContent {
  flex: 1;
  overflow-y: auto;
  padding: 16px 16px 16px 32px;
  position: relative;
}
#timelineContent::before {
  content: "";
  position: absolute;
  left: 22px;
  top: 0;
  bottom: 0;
  width: 2px;
  background: #222;
}

/* Timeline nodes */
.tl-node {
  position: relative;
  padding: 0 0 16px 20px;
}
.tl-dot {
  position: absolute;
  left: -16px;
  top: 3px;
  width: 12px;
  height: 12px;
  border-radius: 50%;
  border: 2px solid #444;
  background: #0a0a0a;
}
.tl-text {
  font-size: 13px;
  color: #ccc;
  line-height: 1.4;
}
.tl-time {
  font-size: 10px;
  color: #444;
  margin-top: 2px;
  font-variant-numeric: tabular-nums;
}

/* Timeline node type colors */
.tl-detect .tl-dot { border-color: #f5a623; background: #2a1f00; }
.tl-propose .tl-dot { border-color: #3498db; background: #0a1a2a; }
.tl-receive .tl-dot { border-color: #3498db; background: #0a1a2a; }
.tl-counter .tl-dot { border-color: #f5a623; background: #2a1f00; }
.tl-accept .tl-dot { border-color: #2d9c3c; background: #0a1a0a; }
.tl-sign .tl-dot { border-color: #2d9c3c; background: #0a1a0a; }
.tl-pay .tl-dot { border-color: #2d9c3c; background: #0a1a0a; }
.tl-reject .tl-dot { border-color: #e74c3c; background: #1a0a0a; }
.tl-doc .tl-dot { border-color: #8e44ad; background: #1a0a1a; }
.tl-tool .tl-dot { border-color: #8e44ad; background: #1a0a1a; }
.tl-message .tl-dot { border-color: #555; background: #111; }

/* ── Bottom Sheet ───────────────────────────── */
.bottom-sheet {
  position: fixed;
  bottom: 0; left: 0; right: 0;
  background: #1a1a1a;
  border-top: 1px solid #333;
  border-radius: 16px 16px 0 0;
  z-index: 80;
  transform: translateY(100%);
  transition: transform 0.3s ease-out;
  max-height: 50vh;
  overflow-y: auto;
}
.bottom-sheet.visible {
  transform: translateY(0);
}
.handle-bar {
  display: flex;
  justify-content: center;
  padding: 10px;
  cursor: pointer;
}
.handle-bar::after {
  content: "";
  width: 40px;
  height: 4px;
  background: #444;
  border-radius: 2px;
}
.bottom-sheet-content {
  padding: 0 20px 24px;
}
#sheetDocTitle {
  font-size: 18px;
  font-weight: bold;
  color: #e0e0e0;
  margin-bottom: 8px;
}
#sheetDocSummary {
  font-size: 13px;
  color: #888;
  line-height: 1.5;
  margin-bottom: 8px;
}
#sheetSigStatus {
  font-size: 12px;
  color: #f5a623;
  margin-bottom: 16px;
}
.sheet-buttons {
  display: flex;
  gap: 10px;
}
.sign-btn {
  flex: 1;
  background: #2d9c3c;
  color: white;
  border: none;
  padding: 14px;
  font-size: 16px;
  font-family: inherit;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
}
.sign-btn:hover { background: #238b31; }
.sign-btn:disabled { background: #333; cursor: default; color: #666; }
.view-full-btn {
  background: #222;
  color: #aaa;
  border: 1px solid #333;
  padding: 14px 20px;
  font-size: 14px;
  font-family: inherit;
  border-radius: 8px;
  cursor: pointer;
}
.view-full-btn:hover { background: #2a2a2a; color: #e0e0e0; }

/* ── Document Overlay (full modal) ──────────── */
#documentOverlay {
  display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.85); z-index: 100;
  justify-content: center; align-items: center;
}
#documentModal {
  background: #111; border: 1px solid #333; border-radius: 8px;
  padding: 24px; max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto;
  position: relative;
}
#documentModal h2 { color: #2d9c3c; margin-bottom: 16px; }
#documentContent { line-height: 1.6; margin-bottom: 16px; }
#documentContent h1, #documentContent h2, #documentContent h3 { color: #e0e0e0; margin: 12px 0 8px; }
#documentContent strong { color: #fff; }
#documentContent ul, #documentContent ol { margin-left: 20px; }
#signatureStatus { color: #f5a623; margin-bottom: 12px; font-size: 14px; }
#signBtn {
  background: #2d9c3c; color: white; border: none; padding: 12px 24px;
  font-size: 16px; font-family: inherit; border-radius: 4px; cursor: pointer;
}
#signBtn:disabled { background: #333; cursor: default; }
#documentOverlay.completed #signatureStatus { color: #2d9c3c; }
#closeDocBtn {
  position: absolute;
  top: 16px; right: 16px;
  background: none;
  border: none;
  color: #888;
  font-size: 20px;
  cursor: pointer;
}
#closeDocBtn:hover { color: #e0e0e0; }

/* ── Mobile ─────────────────────────────────── */
@media (max-width: 768px) {
  .expanded-body { flex-direction: column; }
  .transcript-dual { border-right: none; border-bottom: 1px solid #222; height: 50%; flex-shrink: 0; }
  .workflow-timeline { height: 50%; }
  .top-bar { padding: 10px 14px; }
  #peerName { font-size: 14px; }
  #callTimer { font-size: 16px; }
  #expandBtn { padding: 4px 10px; font-size: 12px; }
}
</style>
</head>
<body>

<!-- Setup Screen -->
<div id="setup">
  <button id="gearBtn" title="Settings">&#9881;</button>
  <h1>Handshake</h1>
  <p class="tagline">Voice-powered agreements</p>
  <form id="profileForm">
    <input id="displayName" placeholder="Your name" required />
    <div class="room-row">
      <input id="roomCode" placeholder="Room code" />
      <button type="button" id="copyRoomBtn" title="Copy room code">&#128203;</button>
    </div>
    <button type="submit">Join Room</button>
  </form>
  <p id="setupStatus"></p>
</div>

<!-- Settings Drawer Overlay -->
<div id="drawerOverlay"></div>

<!-- Settings Drawer -->
<div id="settingsDrawer">
  <div class="drawer-header">
    <h2>Settings</h2>
    <button id="closeDrawerBtn">&times;</button>
  </div>
  <div class="drawer-body">
    <h3>Your Role</h3>
    <input id="role" placeholder="e.g., landlord, plumber, freelancer" />

    <h3>Agent Preferences</h3>
    <label>Style:
      <select id="negStyle">
        <option value="balanced">Balanced</option>
        <option value="aggressive">Aggressive</option>
        <option value="conservative">Conservative</option>
      </select>
    </label>
    <label>Currency:
      <select id="currency">
        <option value="gbp">GBP</option>
        <option value="usd">USD</option>
        <option value="eur">EUR</option>
      </select>
    </label>
    <label>Max auto-approve:
      <div class="currency-prefix">
        <span id="currencySymbol">&pound;</span>
        <input id="maxApprove" type="number" value="50" min="0" step="1" />
      </div>
    </label>
    <label>Escrow:
      <select id="escrowPref">
        <option value="above_threshold">Above threshold</option>
        <option value="always">Always</option>
        <option value="never">Never</option>
      </select>
    </label>
    <label>Escrow threshold:
      <div class="currency-prefix">
        <span id="escrowSymbol">&pound;</span>
        <input id="escrowThreshold" type="number" value="100" min="0" step="1" />
      </div>
    </label>

    <h3>Instructions</h3>
    <textarea id="customInstructions" placeholder="Tell your agent how to negotiate for you..."></textarea>

    <h3>Payment</h3>
    <input id="stripeId" placeholder="Stripe Connect ID (acct_...)" />
    <input id="monzoToken" placeholder="Monzo access token" type="password" />
  </div>
</div>

<!-- Session Screen -->
<div id="session" style="display: none;">

  <!-- Default View -->
  <div id="defaultView" style="display:flex; flex-direction:column; flex:1;">
    <div class="top-bar">
      <div class="top-bar-left">
        <div class="status-dot waiting" id="statusDot"></div>
        <span id="peerName">Waiting for partner...</span>
      </div>
      <div class="top-bar-center">
        <span id="callTimer">00:00</span>
      </div>
      <div class="top-bar-right">
        <button id="audioToggleBtn" title="Audio from peer is muted">&#128263;</button>
        <button id="expandBtn">Details</button>
      </div>
    </div>
    <div class="call-center">
      <div class="pulse-ring"><div class="pulse-ring-inner"></div></div>
      <div id="callStatusText">Listening...</div>
    </div>
  </div>

  <!-- Expanded View -->
  <div id="expandedView" class="expanded-view">
    <div class="expanded-header">
      <h2>Session Details</h2>
      <button id="collapseBtn">&times;</button>
    </div>
    <div class="expanded-body">
      <div class="transcript-dual">
        <div class="transcript-col">
          <div class="transcript-col-header" id="colHeaderA">You</div>
          <div class="transcript-col-content" id="colContentA"></div>
        </div>
        <div class="transcript-divider"></div>
        <div class="transcript-col">
          <div class="transcript-col-header" id="colHeaderB">Peer</div>
          <div class="transcript-col-content" id="colContentB"></div>
        </div>
      </div>
      <div class="workflow-timeline">
        <div class="workflow-timeline-header">Agent Timeline</div>
        <div id="timelineContent"></div>
      </div>
    </div>
  </div>

  <!-- Bottom Sheet (document summary) -->
  <div id="bottomSheet" class="bottom-sheet">
    <div class="handle-bar" id="sheetHandle"></div>
    <div class="bottom-sheet-content">
      <div id="sheetDocTitle"></div>
      <div id="sheetDocSummary"></div>
      <div id="sheetSigStatus"></div>
      <div class="sheet-buttons">
        <button class="sign-btn" id="docSignBtn">Sign Agreement</button>
        <button class="view-full-btn" id="docViewFull">View Full</button>
      </div>
    </div>
  </div>

  <!-- Document Overlay (full modal) -->
  <div id="documentOverlay" style="display: none;">
    <div id="documentModal">
      <button id="closeDocBtn">&times;</button>
      <h2 id="documentTitle"></h2>
      <div id="documentContent"></div>
      <div id="signatureStatus"></div>
      <button id="signBtn">Sign Agreement</button>
    </div>
  </div>
</div>

<script>
// ── Profile Persistence ──────────────────────

const PROFILE_KEY = "handshake_profile";

function loadProfile() {
  try {
    const saved = localStorage.getItem(PROFILE_KEY);
    if (saved) {
      const profile = JSON.parse(saved);
      document.getElementById("displayName").value = profile.displayName ?? "";
      document.getElementById("role").value = profile.role ?? "";
      document.getElementById("customInstructions").value = profile.customInstructions ?? "";
      document.getElementById("maxApprove").value = String((profile.preferences?.maxAutoApproveAmount ?? 5000) / 100);
      document.getElementById("currency").value = profile.preferences?.preferredCurrency ?? "gbp";
      document.getElementById("escrowPref").value = profile.preferences?.escrowPreference ?? "above_threshold";
      document.getElementById("escrowThreshold").value = String((profile.preferences?.escrowThreshold ?? 10000) / 100);
      document.getElementById("negStyle").value = profile.preferences?.negotiationStyle ?? "balanced";
      document.getElementById("stripeId").value = profile.stripeAccountId ?? "";
    }
  } catch { /* ignore parse errors */ }
}

function buildProfile() {
  const profile = {
    displayName: document.getElementById("displayName").value.trim(),
    role: document.getElementById("role").value.trim() || "participant",
    customInstructions: document.getElementById("customInstructions").value.trim(),
    preferences: {
      maxAutoApproveAmount: Math.round(Number(document.getElementById("maxApprove").value) * 100),
      preferredCurrency: document.getElementById("currency").value,
      escrowPreference: document.getElementById("escrowPref").value,
      escrowThreshold: Math.round(Number(document.getElementById("escrowThreshold").value) * 100),
      negotiationStyle: document.getElementById("negStyle").value,
    },
    stripeAccountId: document.getElementById("stripeId").value.trim() || undefined,
    monzoAccessToken: document.getElementById("monzoToken").value.trim() || undefined,
  };
  const toSave = { ...profile };
  delete toSave.monzoAccessToken;
  localStorage.setItem(PROFILE_KEY, JSON.stringify(toSave));
  return profile;
}

// ── Room Code Generation ─────────────────────

function generateRoomCode() {
  const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
  let code = "";
  for (let i = 0; i < 6; i++) {
    code += chars[Math.floor(Math.random() * chars.length)];
  }
  return code;
}

// ── User ID Generation ───────────────────────

function generateUserId(name) {
  const sanitized = name.toLowerCase().replace(/[^a-z0-9]/g, "");
  const suffix = Math.random().toString(36).slice(2, 6);
  return `${sanitized}-${suffix}`;
}

// ── Utilities ────────────────────────────────

function formatTime(ts) {
  const d = new Date(ts);
  return d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", second: "2-digit" });
}

function autoScroll(container) {
  const isNearBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 100;
  if (isNearBottom) {
    container.scrollTop = container.scrollHeight;
  }
}

function escapeHtml(str) {
  return str
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

function markdownToHtml(md) {
  return escapeHtml(md)
    .replace(/^### (.+)$/gm, "<h3>$1</h3>")
    .replace(/^## (.+)$/gm, "<h2>$1</h2>")
    .replace(/^# (.+)$/gm, "<h1>$1</h1>")
    .replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>")
    .replace(/\*(.+?)\*/g, "<em>$1</em>")
    .replace(/^- (.+)$/gm, "<li>$1</li>")
    .replace(/(<li>.*<\/li>)/s, "<ul>$1</ul>")
    .replace(/^\d+\. (.+)$/gm, "<li>$1</li>")
    .replace(/\n\n/g, "<br><br>")
    .replace(/\n/g, "<br>");
}

function derivePeerName(userId) {
  const seg = userId.split("-")[0] || userId;
  return seg.charAt(0).toUpperCase() + seg.slice(1);
}

// ── Session State ────────────────────────────

let myUserId = null;
let myDisplayName = null;
let peerDisplayName = null;
let peerUserId = null;
let callStartTime = null;
let callTimerInterval = null;
let expandedViewOpen = false;
let audioRelayEnabled = false;

const transcriptBuffer = [];
const timelineNodes = [];
let currentDocument = null;
let panelWsRef = null;

// ── Call Timer ───────────────────────────────

function startCallTimer() {
  if (callTimerInterval) return;
  callStartTime = Date.now();
  callTimerInterval = setInterval(updateCallTimer, 1000);
  updateCallTimer();
}

function updateCallTimer() {
  const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
  const mins = String(Math.floor(elapsed / 60)).padStart(2, "0");
  const secs = String(elapsed % 60).padStart(2, "0");
  document.getElementById("callTimer").textContent = `${mins}:${secs}`;
}

// ── Expanded View Toggle ─────────────────────

function openExpandedView() {
  expandedViewOpen = true;
  const el = document.getElementById("expandedView");
  el.style.display = "flex";
  renderFullTranscript();
  renderFullTimeline();
  autoScroll(document.getElementById("colContentA"));
  autoScroll(document.getElementById("colContentB"));
  autoScroll(document.getElementById("timelineContent"));
}

function closeExpandedView() {
  expandedViewOpen = false;
  document.getElementById("expandedView").style.display = "none";
}

document.getElementById("expandBtn").addEventListener("click", openExpandedView);
document.getElementById("collapseBtn").addEventListener("click", closeExpandedView);

// ── Audio Relay Toggle ───────────────────────

document.getElementById("audioToggleBtn").addEventListener("click", () => {
  audioRelayEnabled = !audioRelayEnabled;
  const btn = document.getElementById("audioToggleBtn");
  if (audioRelayEnabled) {
    btn.innerHTML = "&#128264;"; // speaker with sound waves
    btn.classList.add("unmuted");
    btn.title = "Audio from peer is playing";
  } else {
    btn.innerHTML = "&#128263;"; // speaker with X (muted)
    btn.classList.remove("unmuted");
    btn.title = "Audio from peer is muted";
  }
});

// ── Rendering Helpers ────────────────────────

function renderTranscriptEntry(entry) {
  const isLocal = entry.isLocal;
  const col = isLocal
    ? document.getElementById("colContentA")
    : document.getElementById("colContentB");

  const div = document.createElement("div");
  div.className = "t-bubble" + (isLocal ? "" : " t-bubble-peer") + (entry.isPartial ? " t-bubble-partial" : "");
  div.dataset.ts = String(entry.timestamp);
  if (entry.isPartial) div.dataset.partialSpeaker = entry.speaker;

  const text = document.createElement("span");
  text.textContent = entry.text;
  div.appendChild(text);

  if (!entry.isPartial) {
    const time = document.createElement("span");
    time.className = "t-bubble-time";
    time.textContent = formatTime(entry.timestamp);
    div.appendChild(time);
  }

  // Insert in timestamp order
  const existing = col.querySelectorAll(".t-bubble:not(.t-bubble-partial)");
  let inserted = false;
  if (!entry.isPartial) {
    for (let i = existing.length - 1; i >= 0; i--) {
      if (Number(existing[i].dataset.ts) <= entry.timestamp) {
        existing[i].after(div);
        inserted = true;
        break;
      }
    }
  }
  if (!inserted) col.appendChild(div);

  autoScroll(col);
}

function renderFullTranscript() {
  document.getElementById("colContentA").innerHTML = "";
  document.getElementById("colContentB").innerHTML = "";
  for (const entry of transcriptBuffer) {
    if (!entry.isPartial) renderTranscriptEntry(entry);
  }
}

function renderTimelineNode(node) {
  const container = document.getElementById("timelineContent");
  const div = document.createElement("div");
  div.className = `tl-node tl-${node.type}`;

  const dot = document.createElement("div");
  dot.className = "tl-dot";

  const text = document.createElement("div");
  text.className = "tl-text";
  text.textContent = node.text;

  const time = document.createElement("div");
  time.className = "tl-time";
  time.textContent = formatTime(node.timestamp);

  div.appendChild(dot);
  div.appendChild(text);
  div.appendChild(time);
  container.appendChild(div);
  autoScroll(container);
}

function renderFullTimeline() {
  document.getElementById("timelineContent").innerHTML = "";
  for (const node of timelineNodes) {
    renderTimelineNode(node);
  }
}

// ── Message Handlers ─────────────────────────

function handleTranscript(msg, userId) {
  const entry = msg.entry;
  const isLocal = entry.speaker === userId || entry.source === "local";

  if (!entry.isFinal) {
    // Handle partials — update or create temporary bubble
    if (expandedViewOpen) {
      const col = isLocal
        ? document.getElementById("colContentA")
        : document.getElementById("colContentB");
      let partial = col.querySelector(`[data-partial-speaker="${entry.speaker}"]`);
      if (!partial) {
        renderTranscriptEntry({
          speaker: entry.speaker,
          text: entry.text + "...",
          timestamp: entry.timestamp || Date.now(),
          isLocal,
          isPartial: true,
        });
      } else {
        partial.querySelector("span").textContent = entry.text + "...";
      }
    }
    return;
  }

  // Remove partial for this speaker
  if (expandedViewOpen) {
    const col = isLocal
      ? document.getElementById("colContentA")
      : document.getElementById("colContentB");
    const partial = col.querySelector(`[data-partial-speaker="${entry.speaker}"]`);
    if (partial) partial.remove();
  }

  // Buffer final entry
  const bufferEntry = {
    speaker: entry.speaker,
    text: entry.text,
    timestamp: entry.timestamp || Date.now(),
    isLocal,
    isPartial: false,
  };
  transcriptBuffer.push(bufferEntry);

  // Render if expanded
  if (expandedViewOpen) {
    renderTranscriptEntry(bufferEntry);
  }
}

function handleAgent(msg) {
  let type = "message";
  let text = msg.text;

  if (text.startsWith("[Tool:")) {
    type = "tool";
    const nameMatch = text.match(/\[Tool: (.+?)\]/);
    const toolName = nameMatch ? nameMatch[1] : "unknown";
    const result = text.replace(/\[Tool: .+?\] ?/, "");
    text = `${toolName}: ${result}`;
  } else if (/\[Smart Detection\].*TRIGGERED/i.test(text)) {
    type = "detect";
  }

  // Truncate to ~100 chars
  if (text.length > 100) text = text.slice(0, 97) + "...";

  const node = { type, text, timestamp: Date.now() };
  timelineNodes.push(node);

  if (expandedViewOpen) {
    renderTimelineNode(node);
  }
}

function handleNegotiation(msg) {
  const neg = msg.negotiation;
  const statusMap = {
    proposed: "propose",
    countering: "counter",
    accepted: "accept",
    rejected: "reject",
    executing: "pay",
  };
  const type = statusMap[neg.status] || "message";
  const amount = neg.currentProposal
    ? ` \u00A3${(neg.currentProposal.totalAmount / 100).toFixed(2)}`
    : "";
  const text = `${neg.status.toUpperCase()} (Round ${neg.rounds.length}/${neg.maxRounds})${amount}`;

  const node = { type, text, timestamp: Date.now() };
  timelineNodes.push(node);

  if (expandedViewOpen) {
    renderTimelineNode(node);
  }

  // Update default view status text
  const statusText = document.getElementById("callStatusText");
  switch (neg.status) {
    case "proposed": statusText.textContent = "Negotiating..."; break;
    case "countering": statusText.textContent = "Counter-proposal..."; break;
    case "accepted": statusText.textContent = "Agreement reached"; break;
    case "rejected": statusText.textContent = "Proposal rejected"; break;
    case "executing": statusText.textContent = "Processing payment..."; break;
  }
}

function handleExecution(msg) {
  const isSign = msg.step && msg.step.toLowerCase().includes("signature");
  const type = isSign ? "sign" : "pay";
  const text = `${msg.step}: ${msg.status}${msg.details ? " \u2014 " + msg.details : ""}`;

  const node = { type, text: text.length > 100 ? text.slice(0, 97) + "..." : text, timestamp: Date.now() };
  timelineNodes.push(node);

  if (expandedViewOpen) {
    renderTimelineNode(node);
  }
}

function handleDocument(msg, panelWs) {
  const doc = msg.document;
  currentDocument = doc;

  // Add timeline node
  const node = { type: "doc", text: `Document: ${doc.title}`, timestamp: Date.now() };
  timelineNodes.push(node);
  if (expandedViewOpen) renderTimelineNode(node);

  // Populate bottom sheet
  document.getElementById("sheetDocTitle").textContent = doc.title;
  const summary = doc.content.length > 200 ? doc.content.slice(0, 200) + "..." : doc.content;
  document.getElementById("sheetDocSummary").textContent = summary;
  updateBottomSheetSignatureStatus(doc);

  // Wire sign button
  const signBtn = document.getElementById("docSignBtn");
  signBtn.disabled = false;
  signBtn.textContent = "Sign Agreement";
  signBtn.onclick = () => {
    panelWs.send(JSON.stringify({ type: "sign_document", documentId: doc.id }));
    signBtn.disabled = true;
    signBtn.textContent = "Signed \u2713";
  };

  // Wire view-full button
  document.getElementById("docViewFull").onclick = () => {
    showDocumentOverlay(doc, panelWs);
  };

  // Slide up
  document.getElementById("bottomSheet").classList.add("visible");

  // Also populate full overlay (for later)
  populateDocumentOverlay(doc, panelWs);

  // Update default view status
  document.getElementById("callStatusText").textContent = "Document ready for signing";
}

function updateBottomSheetSignatureStatus(doc) {
  const el = document.getElementById("sheetSigStatus");
  const signed = doc.signatures.length;
  const total = doc.parties.length;
  el.textContent = `Signatures: ${signed}/${total}`;
  if (doc.status === "fully_signed") {
    el.textContent += " \u2014 Complete!";
    el.style.color = "#2d9c3c";
  }
}

function populateDocumentOverlay(doc, panelWs) {
  document.getElementById("documentTitle").textContent = doc.title;
  document.getElementById("documentContent").innerHTML = markdownToHtml(doc.content);
  updateSignatureStatus(doc);

  const signBtn = document.getElementById("signBtn");
  signBtn.disabled = false;
  signBtn.textContent = "Sign Agreement";
  signBtn.onclick = () => {
    panelWs.send(JSON.stringify({ type: "sign_document", documentId: doc.id }));
    signBtn.disabled = true;
    signBtn.textContent = "Signed \u2713";
    // Also disable bottom sheet button
    const sheetBtn = document.getElementById("docSignBtn");
    sheetBtn.disabled = true;
    sheetBtn.textContent = "Signed \u2713";
  };
}

function showDocumentOverlay(doc, panelWs) {
  populateDocumentOverlay(doc, panelWs);
  document.getElementById("documentOverlay").style.display = "flex";
}

function updateSignatureStatus(doc) {
  const el = document.getElementById("signatureStatus");
  const signed = doc.signatures.length;
  const total = doc.parties.length;
  el.textContent = `Signatures: ${signed}/${total}`;
  if (doc.status === "fully_signed") {
    el.textContent += " \u2014 Agreement Complete!";
    document.getElementById("documentOverlay").classList.add("completed");
  }
}

function handleStatus(msg) {
  const dot = document.getElementById("statusDot");
  const peerNameEl = document.getElementById("peerName");
  const statusText = document.getElementById("callStatusText");

  if (msg.users && msg.users.length >= 2) {
    dot.className = "status-dot connected";

    // Find peer (the user that isn't me)
    const peer = msg.users.find(u => u !== myUserId);
    if (peer && peer !== peerUserId) {
      peerUserId = peer;
      peerDisplayName = derivePeerName(peer);
      peerNameEl.textContent = peerDisplayName;
      document.getElementById("colHeaderB").textContent = peerDisplayName;
    }

    statusText.textContent = "Listening...";
    startCallTimer();
  } else {
    dot.className = "status-dot waiting";
    peerNameEl.textContent = "Waiting for partner...";
    statusText.textContent = "Waiting...";
  }
}

function handleError(msg) {
  document.getElementById("statusDot").className = "status-dot error";
  document.getElementById("peerName").textContent = `Error: ${msg.message}`;
  document.getElementById("callStatusText").textContent = "Connection error";
}

// ── Bottom Sheet Dismiss ─────────────────────

document.getElementById("sheetHandle").addEventListener("click", () => {
  document.getElementById("bottomSheet").classList.remove("visible");
});

// ── Document Overlay Close ───────────────────

document.getElementById("closeDocBtn").addEventListener("click", () => {
  document.getElementById("documentOverlay").style.display = "none";
});

// ── Settings Drawer ──────────────────────────

function openDrawer() {
  document.getElementById("drawerOverlay").classList.add("open");
  document.getElementById("settingsDrawer").classList.add("open");
}

function closeDrawer() {
  document.getElementById("drawerOverlay").classList.remove("open");
  document.getElementById("settingsDrawer").classList.remove("open");
}

document.getElementById("gearBtn").addEventListener("click", openDrawer);
document.getElementById("closeDrawerBtn").addEventListener("click", closeDrawer);
document.getElementById("drawerOverlay").addEventListener("click", closeDrawer);

document.addEventListener("keydown", (e) => {
  if (e.key === "Escape" && document.getElementById("settingsDrawer").classList.contains("open")) {
    closeDrawer();
  }
});

// Copy room code to clipboard
document.getElementById("copyRoomBtn").addEventListener("click", () => {
  const code = document.getElementById("roomCode").value;
  if (!code) return;
  navigator.clipboard.writeText(code).then(() => {
    const btn = document.getElementById("copyRoomBtn");
    btn.innerHTML = "&#10003;";
    btn.style.color = "#2d9c3c";
    setTimeout(() => { btn.innerHTML = "&#128203;"; btn.style.color = ""; }, 1500);
  });
});

// Sync currency symbol when dropdown changes
const CURRENCY_SYMBOLS = { gbp: "\u00A3", usd: "$", eur: "\u20AC" };
document.getElementById("currency").addEventListener("change", (e) => {
  const sym = CURRENCY_SYMBOLS[e.target.value] || "\u00A3";
  document.getElementById("currencySymbol").textContent = sym;
  document.getElementById("escrowSymbol").textContent = sym;
});

// ── Form Submit ──────────────────────────────

document.getElementById("profileForm").addEventListener("submit", (e) => {
  e.preventDefault();
  const profile = buildProfile();
  if (!profile.displayName) {
    document.getElementById("setupStatus").textContent = "Name is required";
    return;
  }
  const roomCode = document.getElementById("roomCode").value.trim();
  if (!roomCode) {
    document.getElementById("setupStatus").textContent = "Room code is required";
    return;
  }
  const userId = generateUserId(profile.displayName);
  myUserId = userId;
  myDisplayName = profile.displayName;
  document.getElementById("colHeaderA").textContent = profile.displayName;
  startSession(userId, roomCode, profile);
});

// ── Session Start ────────────────────────────

function startSession(userId, roomCode, profile) {
  document.getElementById("setup").style.display = "none";
  document.getElementById("session").style.display = "flex";

  const wsProtocol = location.protocol === "https:" ? "wss:" : "ws:";
  const baseUrl = `${wsProtocol}//${location.host}`;

  let audioWs = null;

  const panelWs = new WebSocket(
    `${baseUrl}/ws/panels?room=${encodeURIComponent(roomCode)}&user=${encodeURIComponent(userId)}`
  );
  panelWsRef = panelWs;

  panelWs.addEventListener("open", () => {
    panelWs.send(JSON.stringify({ type: "set_profile", profile }));
    panelWs.send(JSON.stringify({ type: "join_room", roomId: roomCode }));
  });

  function connectAudio() {
    if (audioWs) return;
    audioWs = new WebSocket(
      `${baseUrl}/ws/audio?room=${encodeURIComponent(roomCode)}&user=${encodeURIComponent(userId)}`
    );
    audioWs.binaryType = "arraybuffer";
    audioWs.addEventListener("open", () => {
      startMicrophone(audioWs);
    });
    setupAudioPlayback(audioWs);
  }

  setupPanelHandler(panelWs, userId, connectAudio);
}

// ── Microphone Capture ───────────────────────

async function startMicrophone(audioWs) {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      audio: { sampleRate: 16000, channelCount: 1, echoCancellation: true, noiseSuppression: true },
    });

    const audioContext = new AudioContext({ sampleRate: 16000 });
    const source = audioContext.createMediaStreamSource(stream);
    const processor = audioContext.createScriptProcessor(4096, 1, 1);

    processor.onaudioprocess = (event) => {
      if (audioWs.readyState !== WebSocket.OPEN) return;
      const float32 = event.inputBuffer.getChannelData(0);
      const int16 = new Int16Array(float32.length);
      for (let i = 0; i < float32.length; i++) {
        const s = Math.max(-1, Math.min(1, float32[i]));
        int16[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
      }
      audioWs.send(int16.buffer);
    };

    source.connect(processor);
    processor.connect(audioContext.destination);
  } catch (err) {
    console.error("Microphone error:", err);
    document.getElementById("callStatusText").textContent = "Microphone access denied";
    document.getElementById("statusDot").className = "status-dot error";
  }
}

// ── Audio Playback ───────────────────────────

function setupAudioPlayback(audioWs) {
  let playbackContext = null;
  let nextPlayTime = 0;

  audioWs.addEventListener("message", (event) => {
    if (typeof event.data === "string") return;
    if (!audioRelayEnabled) return;

    if (!playbackContext) {
      playbackContext = new AudioContext({ sampleRate: 16000 });
      nextPlayTime = playbackContext.currentTime;
    }

    const int16 = new Int16Array(event.data);
    const float32 = new Float32Array(int16.length);
    for (let i = 0; i < int16.length; i++) {
      float32[i] = int16[i] / (int16[i] < 0 ? 0x8000 : 0x7FFF);
    }

    const buffer = playbackContext.createBuffer(1, float32.length, 16000);
    buffer.getChannelData(0).set(float32);

    const source = playbackContext.createBufferSource();
    source.buffer = buffer;
    source.connect(playbackContext.destination);

    const now = playbackContext.currentTime;
    if (nextPlayTime < now) nextPlayTime = now;
    source.start(nextPlayTime);
    nextPlayTime += buffer.duration;
  });
}

// ── Panel Message Handler ────────────────────

function setupPanelHandler(panelWs, userId, onRoomJoined) {
  panelWs.addEventListener("message", (event) => {
    try {
      const msg = JSON.parse(event.data);
      switch (msg.panel) {
        case "transcript": handleTranscript(msg, userId); break;
        case "agent": handleAgent(msg); break;
        case "negotiation": handleNegotiation(msg); break;
        case "document": handleDocument(msg, panelWs); break;
        case "execution": handleExecution(msg); break;
        case "status":
          handleStatus(msg);
          if (onRoomJoined) { onRoomJoined(); onRoomJoined = null; }
          break;
        case "error": handleError(msg); break;
      }
    } catch { /* ignore malformed messages */ }
  });
}

// ── Init ─────────────────────────────────────

loadProfile();
document.getElementById("roomCode").value = generateRoomCode();
</script>
</body>
</html>
